# Markitai Overall Optimization Report (v1)

> 基于当前代码库与 `docs/requirement.md` / `docs/spec.md` 的全量对照分析。当前阶段不改代码，仅输出风险与优化建议。所有可能改变行为/产生破坏性影响的建议均标注“需要确认”。

## 0. 背景与范围

- 范围：覆盖 CLI、配置、转换器、LLM、图片/ocr、批处理、日志、安全、测试等核心模块。
- 对照文档：`docs/requirement.md`、`docs/spec.md`。
- 产出：本报告 + 后续确认后再进入实现。
- 约束：不修改代码；发现不一致先列出并标注“需要确认”。

## 1. 进度评估

- 需求/规格与现实现已具备核心链路（转换、LLM、图片分析、批处理、日志/安全等）。
- 关键缺口集中在“文档一致性、并发调度、重试/统计准确性、输出产物策略、测试覆盖”。
- 需要用户确认的行为性决策已收集并在报告末尾列出。

## 2. 当前实现概览（模块职责图）

```
CLI (click)
  ├─ config.py  : 配置加载/合并
  ├─ batch.py   : 批处理、状态文件、进度展示
  ├─ converter/ : PDF/Office/Image/Text/Legacy 转换
  ├─ image.py   : 图片压缩/分析
  ├─ ocr.py     : OCR 管道
  ├─ llm.py     : LiteLLM Router + Instructor
  ├─ prompts/   : 提示词加载
  ├─ security.py: 路径/大小/安全限制
```

- 实现与文档总体方向一致，但存在多处行为/命名差异与可维护性风险。

## 3. 文档一致性差异清单（现状/影响/方案）

> 说明：每条均标记“是否破坏性”和“需要确认”。

### 3.1 CLI 技术栈描述不一致
- 现状：`docs/spec.md` 架构图写 Typer，但实现为 Click（`packages/markitai/src/markitai/cli.py`）。
- 影响：文档自相矛盾，误导扩展与测试说明。
- 方案 A：统一文档为 Click（非破坏性）。
- 方案 B：迁移至 Typer（破坏性：CLI 行为/依赖/测试）。
- 是否破坏性：A 否 / B 是
- 需要确认：若考虑迁移需确认。

### 3.2 图片描述输出格式（已确认）
- 现状：实现输出 `assets.desc.json` 聚合文件；`spec.md` 中存在“每图 .md 描述”的描述。
- 影响：输出产物与文档不一致，影响用户预期与脚本兼容。
- 方案：以聚合 JSON 为唯一权威输出；文档更新为 JSON。
- 是否破坏性：否（文档对齐）。
- 需要确认：已确认（聚合 JSON）。

### 3.3 image.enabled 语义冲突（已确认）
- 现状：`image.enabled` 注释为“图片提取/处理”，但流程中控制点在 alt/desc 开关，语义分裂。
- 影响：配置语义不清，用户难以预测是否提取/保存图片。
- 方案：移除 `image.enabled` 配置，改由 `alt/desc` 或单独“提取开关”明确控制。
- 是否破坏性：是（配置项移除）。
- 需要确认：已确认（移除该配置）。

### 3.4 --concurrency 语义（已确认）
- 现状：CLI `-j/--concurrency` 仅覆盖 batch 并发，LLM 并发仍独立配置。
- 影响：用户以为统一并发，实则未限制 LLM 请求并发。
- 方案：拆分为 `--batch-concurrency` / `--llm-concurrency`。
- 是否破坏性：是（CLI 参数变化）。
- 需要确认：已确认（拆分参数）。

### 3.5 重试策略不一致（已确认）
- 现状：实现禁用 router 内重试且默认 0，`spec.md` 强调重试与日志；文档示例与实现偏差。
- 影响：实际默认不重试，稳定性与规格不符。
- 方案：默认启用有限次重试 + 指数退避，明确记录重试事件。
- 是否破坏性：是（行为改变、成本变化）。
- 需要确认：已确认（启用重试）。

### 3.6 screenshot 归属不一致（已确认）
- 现状：实现将 `--screenshot` 落到 `ocr.enable_screenshot`，概念耦合 OCR。
- 影响：功能边界混乱，难以扩展/配置。
- 方案：拆分为独立模块/配置项。
- 是否破坏性：是（配置迁移）。
- 需要确认：已确认（独立配置）。

### 3.7 Token/成本统计权威性（已确认）
- 现状：`llm.py` 的 instructor 路径使用固定估算 `_track_usage(..., 1000, 200, 0.001)`，与真实不符。
- 影响：报告成本/统计误导。
- 方案：标记为 estimated/unknown，避免误导；后续再补齐真实统计。
- 是否破坏性：否（报告/日志字段变化）。
- 需要确认：已确认（标记估算）。

### 3.8 图片描述命名规则
- 现状：文档写 `{图片文件名}.md`，实现聚合 JSON。
- 影响：同 3.2。
- 方案：文档统一为 `assets.desc.json`。
- 是否破坏性：否。
- 需要确认：无需新增。

## 4. 架构与代码健康度

- 边界清晰度：转换/LLM/图片/批处理模块已分层，但 CLI 层承担过多流程编排，重复 async 管理。
- 命名语义：`image.enabled`、`screenshot` 与 OCR 的关系不清晰，建议拆分职责并统一命名。
- 配置一致性：`batch.concurrency` 与 `llm.concurrency` 并存，CLI 只有一个参数，需显式分层。
- 可扩展性：多格式转换器已齐，但错误与降级处理分散，缺少统一策略层。
- 文档同步：spec 内部自相矛盾（Typer vs Click / .md vs JSON），需一次性修正。

## 5. 并发与性能瓶颈

- 图像分析使用 `asyncio.gather` 对所有图片并发创建任务，易在多图文档触发瞬时任务爆发与限流。
  - 建议：采用“图片分析队列 + 并发上限 + 批量调度”（已确认）。
- 单文件流程多次 `asyncio.run()`，增加开销并引入事件循环嵌套风险。
  - 建议：改为单事件循环 + pipeline 协程串联（已确认，短期执行）。
- OCR/渲染 CPU/IO 混合，缺少 executor 隔离，批处理高并发时会阻塞主 loop。
  - 建议：OCR/转换入线程池并单独限制并发（已确认）。
- PDF embedded image 写盘与压缩链路未完全一致，可能造成资源体积不可控。
  - 建议：统一压缩管线与输出策略（已确认）。

## 6. 可靠性与降级

- LLM 重试默认关闭导致稳定性偏低；已确认启用重试并需要完善日志和退避策略。
- LLM 失败的降级逻辑存在，但部分场景仍会抛出异常中断处理；建议“每文件兜底” + “可恢复中断”（已确认，短期目标）。
- 批处理状态文件每文件写入一次，在大量文件下 I/O 成本高，可能拖慢整体吞吐。
  - 建议：增量缓存 + 时间间隔 flush（已确认）。

## 7. 成本与 token 统计准确性

- 现状：部分 LLM 路径使用硬编码估算，汇总成本不可信。
- 风险：报告误导、预算不可控、A/B 模型对比无效。
- 已确认方向：统计标记为 estimated/unknown；后续改为从 LiteLLM 响应中取真实 token 与成本。

## 8. I/O 与输出产物策略

- 输出规范与文档不一致：图片描述文件采用聚合 JSON（已确认）。
- 输出覆盖策略：建议严格防覆盖并校验软链接（已确认），需要补充规则与测试（尤其是批处理多次输出）。
- 状态文件写入频率：当前偏高，建议批处理按批次/时间间隔写入（已确认）。
- 报告输出：`output/reports/*.report.json` 已存在于实现（已确认），需在文档中明确其为现行能力。

## 9. 安全审计

- 已有措施：路径 traversal、glob/size 限制、state 文件大小保护、输入大小限制等。
- 风险与建议：
  - 输出目录覆盖策略与软链接覆盖场景需明确，建议严格防覆盖并显式报错（已确认）。
  - glob/rglob 大目录扫描边界建议默认最大深度 5（可配置），并可设置最大文件数防止扫描过载（已确认）。
  - 多文件输入下的资源消耗（OCR + LLM + 图像分析）存在 DoS 风险，需全局并发上限。

## 10. 测试现状与补齐计划

- 现状：已有 `tests/SKILL.md` 与部分单元/批处理测试。
- 明显缺口：
  - 重试/限流/超时行为测试（LLM 与 OCR）。
  - OCR + LLM / PPTX + LLM 的端到端集成测试。
  - 预设输出矩阵测试（minimal/standard/rich 的产物集合）。
  - `assets.desc.json` 稳定性测试（重复运行/合并行为）。
- 优先级建议：
  - P0：重试/降级 + 并发限制 + 统计准确性。
  - P1：预设输出矩阵 + 关键格式集成测试。
  - P2：大规模批处理性能回归测试。

## 11. 迁移与兼容性建议

- CLI 参数拆分与配置项移除（`--concurrency` 拆分、移除 `image.enabled`）会影响脚本与文档，需要版本号变更与迁移指南。需要确认。
- screenshot 配置解耦 OCR 需要配置迁移说明与默认值策略。需要确认。
- LLM 重试默认开启会改变成本与延迟，需升级说明与可配置化。需要确认。

## 12. 需要确认的决策清单

> 标记“已确认”的项可进入后续实施计划；其余需进一步确认。

- 已确认：图片描述仅输出 `assets.desc.json` 聚合文件。
- 已确认：移除 `image.enabled` 配置项。
- 已确认：拆分 `--batch-concurrency` / `--llm-concurrency`。
- 已确认：LLM 默认启用有限重试 + 指数退避。
- 已确认：`screenshot` 配置与 OCR 解耦。
- 已确认：token/cost 统计标记为 estimated/unknown。
- 已确认：图片分析任务队列化与并发上限策略。
- 已确认：OCR/转换线程池隔离并限制并发。
- 已确认：PDF embedded image 压缩链路统一。
- 已确认：批处理状态文件写入节流策略。
- 已确认：`output/reports/*.report.json` 已存在于实现，文档需明确其为现行能力。
- 已确认：输出目录严格防覆盖并校验软链接。
- 已确认：glob/rglob 默认最大深度 5（可配置），并可设置最大文件数限制。
- 已确认：单文件多次 `asyncio.run()` 调整为短期执行。
- 已确认：LLM 失败降级的更强兜底策略作为短期目标。

---

## 结论

整体实现已覆盖需求主链路，但文档一致性、并发治理、重试/统计准确性、I/O 策略与测试覆盖仍需系统化优化。建议先完成文档与配置语义统一，再进入并发/可靠性改造与测试补齐。

## 附：分阶段实施计划（按优先级）

### P0 可靠性与并发治理（短期）
- 单事件循环：消除单文件多次 `asyncio.run()`，改为单 loop pipeline。
- 图片分析队列化：引入队列 + 并发上限，避免瞬时任务爆发。
- OCR/转换线程池：CPU/IO 重任务入线程池并限流。
- LLM 失败兜底：每文件降级不中断，完善重试与退避日志。
- 统计可信标记：对估算 token/cost 标记 `estimated/unknown`。

### P1 配置与接口一致性（短期）
- CLI 参数拆分：新增 `--batch-concurrency` / `--llm-concurrency`。
- 配置语义清理：移除 `image.enabled`，明确由 alt/desc/提取开关驱动。
- screenshot 解耦 OCR：独立配置项与模块边界。
- 文档同步：Click、`assets.desc.json`、`output/reports/*.report.json` 等现行能力对齐。

### P2 输出/I/O 与安全策略（中期）
- PDF 图片链路统一：嵌入图像压缩后再写盘。
- state 文件节流写入：按时间/批次 flush。
- 输出目录严格防覆盖：软链接校验并显式报错。
- glob/rglob 边界：默认最大深度 5（可配置）+ 最大文件数限制。

### P3 测试补齐（中期）
- 重试/限流/降级行为测试。
- 预设输出矩阵测试（minimal/standard/rich）。
- OCR+LLM、PPTX+LLM 端到端集成测试。
- `assets.desc.json` 稳定性/幂等性测试。

### P4 可观测性与成本准确性（后续）
- 从 LiteLLM 响应获取真实 token/cost。
- 统一报告/日志口径，支持批处理汇总。

## 进展报告（2026-01-17）

- 已完成 P0/P1/P2 里核心开发：单事件循环、图片分析队列并发、LLM 重试默认、OCR/转换线程池化（`asyncio.to_thread`）、截图配置解耦、PDF 图片压缩链路统一、state 写入节流、输出目录 symlink 安全与覆盖控制、报告 token_status 标记、CLI 并发参数拆分、`image.enabled` 移除与配置语义清理。
- 追加 P3/P4 的关键补齐：扫描边界（scan_max_depth/scan_max_files）与测试覆盖、真实 token/cost 统计由 LiteLLM 响应驱动（移除估算路径），并更新相关手册。
- 文档与 Schema 已同步：`docs/spec.md`、`packages/markitai/src/markitai/config.schema.json`、`packages/markitai/src/markitai/config.py`、`packages/markitai/tests/SKILL.md`、相关测试同步更新。
- 全量测试已通过：`uv run pytest`（194 passed，含 integration + unit）。
- 仍未完成项：大规模性能回归测试（需明确数据规模与环境）。
