# OpenClaw ä»£ç åº“æ·±åº¦æ¶æ„åˆ†ææŠ¥å‘Š

**è°ƒç ”æ—¥æœŸ**: 2026å¹´1æœˆ31æ—¥  
**ç›®æ ‡è¯»è€…**: æ¶æ„å¸ˆã€åº”ç”¨å¼€å‘è€…  
**ç”¨é€”**: æ„å»ºç±»ä¼¼ç³»ç»Ÿçš„æŠ€æœ¯é€‰å‹å‚è€ƒ

---

## 1. é¡¹ç›®æ¦‚è¿°ä¸å®šä½

OpenClawï¼ˆæ›¾ç”¨å Clawdbotã€Moltbotï¼‰æ˜¯ä¸€ä¸ª**è‡ªæ‰˜ç®¡çš„å¼€æº AI ä¸ªäººåŠ©æ‰‹å¹³å°**ï¼Œå…¶æ ¸å¿ƒå·®å¼‚åŒ–åœ¨äºï¼š

- **æœ¬åœ°ä¼˜å…ˆæ¶æ„**: æ•°æ®å®Œå…¨å­˜å‚¨åœ¨ç”¨æˆ·è®¾å¤‡ä¸Š
- **æ¶ˆæ¯å¹³å°é›†æˆ**: ç»Ÿä¸€æ¥å…¥ 13+ å³æ—¶é€šè®¯å¹³å°
- **çœŸæ­£çš„ä»£ç†èƒ½åŠ›**: ä¸ä»…å¯¹è¯ï¼Œè¿˜èƒ½æ‰§è¡Œ shell å‘½ä»¤ã€æ§åˆ¶æµè§ˆå™¨ã€æ“ä½œæ–‡ä»¶ç³»ç»Ÿ
- **ä¸»åŠ¨äº¤äº’**: æ”¯æŒå®šæ—¶ä»»åŠ¡ã€äº‹ä»¶è§¦å‘ï¼Œå¯ä¸»åŠ¨è”ç³»ç”¨æˆ·

**æŠ€æœ¯æŒ‡æ ‡**:
- GitHub Stars: 117,000+
- æäº¤æ•°: 8,300+
- è´¡çŒ®è€…: 150+
- å¼€æºåè®®: MIT

---

## 2. æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 é«˜å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶ˆæ¯å¹³å°å±‚ (Messaging Layer)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚WhatsApp â”‚Telegram â”‚ Discord â”‚  Slack  â”‚ Signal  â”‚iMessage â”‚ WebChat/... â”‚
â”‚(Baileys)â”‚ (grammY)â”‚(discord â”‚ (Bolt)  â”‚(signal- â”‚ (imsg)  â”‚             â”‚
â”‚         â”‚         â”‚   .js)  â”‚         â”‚  cli)   â”‚         â”‚             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚         â”‚         â”‚         â”‚         â”‚         â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Gateway (æ§åˆ¶å¹³é¢æ ¸å¿ƒ)                                â”‚
â”‚                    ws://127.0.0.1:18789                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ WebSocket Server (JSON-RPC é£æ ¼åè®®)                            â”‚  â”‚
â”‚  â”‚ â€¢ Session Manager (ä¼šè¯ç®¡ç† + æ¶ˆæ¯è·¯ç”±)                            â”‚  â”‚
â”‚  â”‚ â€¢ Channel Router (å¤šæ¸ é“æ¶ˆæ¯åˆ†å‘)                                  â”‚  â”‚
â”‚  â”‚ â€¢ Tool Registry (å·¥å…·æ³¨å†Œä¸è°ƒç”¨)                                   â”‚  â”‚
â”‚  â”‚ â€¢ Cron Scheduler (å®šæ—¶ä»»åŠ¡)                                       â”‚  â”‚
â”‚  â”‚ â€¢ Presence Manager (åœ¨çº¿çŠ¶æ€)                                     â”‚  â”‚
â”‚  â”‚ â€¢ Config Validator (TypeBox Schema æ ¡éªŒ)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pi Agent      â”‚    â”‚   CLI Client    â”‚    â”‚   Node Clients  â”‚
â”‚   (AI Runtime)  â”‚    â”‚ (openclaw ...)  â”‚    â”‚ (macOS/iOS/     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚  Android)       â”‚
â”‚ â€¢ RPC æ¨¡å¼      â”‚    â”‚ â€¢ å‘½ä»¤è¡Œäº¤äº’     â”‚    â”‚ â€¢ Canvas æ¸²æŸ“   â”‚
â”‚ â€¢ Tool æµå¼è°ƒç”¨ â”‚    â”‚ â€¢ è„šæœ¬è‡ªåŠ¨åŒ–     â”‚    â”‚ â€¢ æ‘„åƒå¤´/å±å¹•   â”‚
â”‚ â€¢ å¤šæ¨¡å‹æ”¯æŒ    â”‚    â”‚ â€¢ å¥åº·æ£€æŸ¥       â”‚    â”‚ â€¢ è¯­éŸ³å”¤é†’      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Tool Layer (å·¥å…·å±‚)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  exec   â”‚ browser â”‚  read/  â”‚ canvas  â”‚  cron   â”‚sessions â”‚  nodes.*    â”‚
â”‚ (shell) â”‚  (CDP)  â”‚  write  â”‚ (A2UI)  â”‚(å®šæ—¶)   â”‚(å¤šä¼šè¯) â”‚ (è®¾å¤‡æ§åˆ¶)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

| åŸåˆ™ | å®ç°æ–¹å¼ |
|------|----------|
| **å•ä¸€æ§åˆ¶å¹³é¢** | ä¸€ä¸ª Gateway è¿›ç¨‹ç®¡ç†æ‰€æœ‰æ¶ˆæ¯æ¸ é“å’Œå®¢æˆ·ç«¯è¿æ¥ |
| **åè®®ä¼˜å…ˆ** | TypeBox å®šä¹‰ Schema â†’ JSON Schema â†’ Swift æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆ |
| **ä¼šè¯éš”ç¦»** | ä¸»ä¼šè¯ (main) ä¸ç¾¤ç»„ä¼šè¯åˆ†ç¦»ï¼Œæ”¯æŒæ²™ç®±æ¨¡å¼ |
| **æœ¬åœ°ä¿¡ä»»** | æœ¬åœ°å›ç¯è¿æ¥å¯è‡ªåŠ¨æ‰¹å‡†ï¼Œè¿œç¨‹è¿æ¥éœ€é…å¯¹ç¡®è®¤ |
| **å·¥å…·å¯æ§** | å·¥å…·ç™½åå•/é»‘åå•æœºåˆ¶ï¼Œæ”¯æŒæŒ‰ä¼šè¯ç²’åº¦æ§åˆ¶ |

---

## 3. æŠ€æœ¯æ ˆè¯¦è§£

### 3.1 è¿è¡Œæ—¶ä¸æ„å»ºå·¥å…·

| ç±»åˆ« | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| **è¿è¡Œæ—¶** | Node.js â‰¥22 | å¿…é¡»ï¼ŒWhatsApp/Telegram ç­‰ä¾èµ– |
| **è¯­è¨€** | TypeScript | ä¸¥æ ¼ç±»å‹ï¼Œtsx ç›´æ¥è¿è¡Œ |
| **åŒ…ç®¡ç†** | pnpm (æ¨è) | æ”¯æŒ npm/bunï¼Œpnpm ç”¨äºå¼€å‘æ„å»º |
| **æ„å»º** | tsc + è‡ªå®šä¹‰è„šæœ¬ | äº§å‡º dist/ ç”¨äºæ‰“åŒ…å‘å¸ƒ |
| **æµ‹è¯•** | Vitest | V8 è¦†ç›–ç‡ï¼Œ70% é˜ˆå€¼ |
| **Lint/Format** | oxlint + oxfmt + Prettier | å¿«é€Ÿçš„ Rust å·¥å…·é“¾ |
| **Schema** | TypeBox | ç±»å‹å®‰å…¨çš„ JSON Schema ç”Ÿæˆå™¨ |

### 3.2 Monorepo ç»“æ„

```
openclaw/
â”œâ”€â”€ src/                    # æ ¸å¿ƒæºç 
â”‚   â”œâ”€â”€ gateway/           # Gateway WebSocket æœåŠ¡å™¨
â”‚   â”œâ”€â”€ agent/             # Pi Agent è¿è¡Œæ—¶
â”‚   â”œâ”€â”€ telegram/          # Telegram æ¸ é“ (grammY)
â”‚   â”œâ”€â”€ discord/           # Discord æ¸ é“ (discord.js)
â”‚   â”œâ”€â”€ slack/             # Slack æ¸ é“ (Bolt)
â”‚   â”œâ”€â”€ signal/            # Signal æ¸ é“ (signal-cli)
â”‚   â”œâ”€â”€ imessage/          # iMessage æ¸ é“ (imsg CLI)
â”‚   â”œâ”€â”€ web/               # WhatsApp Web (Baileys)
â”‚   â”œâ”€â”€ channels/          # æ¸ é“æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ routing/           # æ¶ˆæ¯è·¯ç”±é€»è¾‘
â”‚   â”œâ”€â”€ tools/             # å†…ç½®å·¥å…·å®ç°
â”‚   â”œâ”€â”€ sessions/          # ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ config/            # é…ç½®åŠ è½½ä¸æ ¡éªŒ
â”‚
â”œâ”€â”€ extensions/            # æ‰©å±•æ¸ é“ (æ’ä»¶å½¢å¼)
â”‚   â”œâ”€â”€ msteams/          # Microsoft Teams
â”‚   â”œâ”€â”€ matrix/           # Matrix
â”‚   â”œâ”€â”€ zalo/             # Zalo
â”‚   â”œâ”€â”€ googlechat/       # Google Chat
â”‚   â”œâ”€â”€ voice-call/       # è¯­éŸ³é€šè¯
â”‚   â””â”€â”€ memory-core/      # è®°å¿†ç³»ç»Ÿ
â”‚
â”œâ”€â”€ apps/                  # åŸç”Ÿåº”ç”¨
â”‚   â””â”€â”€ macos/            # macOS Swift åº”ç”¨
â”‚       â””â”€â”€ Sources/
â”‚           â””â”€â”€ MoltbotProtocol/  # è‡ªåŠ¨ç”Ÿæˆçš„åè®®æ¨¡å‹
â”‚
â”œâ”€â”€ ui/                    # Web UI æºç 
â”‚   â””â”€â”€ control-ui/       # Control UI (React/Vue?)
â”‚
â”œâ”€â”€ skills/                # å†…ç½®æŠ€èƒ½
â”‚   â””â”€â”€ */SKILL.md        # æŠ€èƒ½å®šä¹‰æ–‡ä»¶
â”‚
â”œâ”€â”€ vendor/                # ç¬¬ä¸‰æ–¹ä¾èµ–
â”‚   â””â”€â”€ a2ui/             # A2UI Canvas åº“
â”‚
â”œâ”€â”€ scripts/               # æ„å»º/å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ protocol-gen.ts   # åè®® Schema ç”Ÿæˆ
â”‚   â”œâ”€â”€ protocol-gen-swift.ts  # Swift æ¨¡å‹ç”Ÿæˆ
â”‚   â””â”€â”€ bundle-a2ui.sh    # A2UI æ‰“åŒ…
â”‚
â”œâ”€â”€ test/                  # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ docs/                  # æ–‡æ¡£
â”œâ”€â”€ patches/               # ä¾èµ–è¡¥ä¸
â”‚
â”œâ”€â”€ package.json           # æ ¹é…ç½®
â”œâ”€â”€ pnpm-workspace.yaml    # pnpm å·¥ä½œåŒº
â”œâ”€â”€ tsconfig.json          # TypeScript é…ç½®
â”œâ”€â”€ vitest.config.ts       # æµ‹è¯•é…ç½®
â”œâ”€â”€ vitest.e2e.config.ts   # E2E æµ‹è¯•
â”œâ”€â”€ vitest.gateway.config.ts
â”œâ”€â”€ vitest.live.config.ts
â”‚
â”œâ”€â”€ Dockerfile             # æ ‡å‡† Docker
â”œâ”€â”€ Dockerfile.sandbox     # æ²™ç®± Docker
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ fly.toml               # Fly.io éƒ¨ç½²
â””â”€â”€ render.yaml            # Render éƒ¨ç½²
```

### 3.3 å…³é”®ä¾èµ–åˆ†æ

**æ¶ˆæ¯å¹³å° SDK**:

| å¹³å° | ä¾èµ–åº“ | ç‰¹ç‚¹ |
|------|--------|------|
| WhatsApp | `@whiskeysockets/baileys` | Web åè®®é€†å‘ï¼Œéœ€ QR é…å¯¹ |
| Telegram | `grammy` | Bot APIï¼Œè½»é‡é«˜æ•ˆ |
| Discord | `discord.js` | åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒæ–œæ å‘½ä»¤ |
| Slack | `@slack/bolt` | å®˜æ–¹ SDKï¼ŒSocket Mode |
| Signal | `signal-cli` | CLI å·¥å…·å°è£… |
| iMessage | `imsg` | macOS ä¸“ç”¨ CLI |

**æ ¸å¿ƒä¾èµ–**:

```json
{
  "dependencies": {
    "@sinclair/typebox": "^0.x",      // Schema å®šä¹‰
    "ws": "^8.x",                      // WebSocket æœåŠ¡
    "puppeteer-core": "^x.x",          // æµè§ˆå™¨æ§åˆ¶ (CDP)
    "zod": "^3.x"                      // è¿è¡Œæ—¶æ ¡éªŒ (éƒ¨åˆ†)
  },
  "devDependencies": {
    "typescript": "^5.x",
    "tsx": "^4.x",                     // TS ç›´æ¥æ‰§è¡Œ
    "vitest": "^x.x",
    "oxlint": "^x.x"
  }
}
```

---

## 4. Gateway æ ¸å¿ƒå®ç°

### 4.1 WebSocket åè®®è®¾è®¡

Gateway é‡‡ç”¨**ç±» JSON-RPC çš„è‡ªå®šä¹‰åè®®**ï¼Œä¸‰ç§å¸§ç±»å‹ï¼š

```typescript
// è¯·æ±‚å¸§
interface RequestFrame {
  type: "req";
  id: string;           // è¯·æ±‚ ID
  method: string;       // æ–¹æ³•å
  params?: object;      // å‚æ•°
  idempotencyKey?: string;  // å¹‚ç­‰é”® (send/agent å¿…å¡«)
}

// å“åº”å¸§
interface ResponseFrame {
  type: "res";
  id: string;           // å¯¹åº”è¯·æ±‚ ID
  ok: boolean;
  payload?: object;     // æˆåŠŸæ—¶
  error?: object;       // å¤±è´¥æ—¶
}

// äº‹ä»¶å¸§ (æœåŠ¡ç«¯æ¨é€)
interface EventFrame {
  type: "event";
  event: string;        // äº‹ä»¶å
  payload: object;
  seq?: number;         // åºåˆ—å·
  stateVersion?: number;
}
```

**è¿æ¥ç”Ÿå‘½å‘¨æœŸ**:

```
Client                         Gateway
   |                              |
   |------ req:connect ---------->|  é¦–å¸§å¿…é¡»æ˜¯ connect
   |<----- res (hello-ok) --------|  æºå¸¦ presence + health å¿«ç…§
   |                              |
   |<----- event:presence --------|  çŠ¶æ€å˜æ›´æ¨é€
   |<----- event:tick ------------|  å¿ƒè·³
   |                              |
   |------ req:agent ------------>|  å‘èµ· AI è°ƒç”¨
   |<----- res (accepted) --------|  ACK: {runId, status}
   |<----- event:agent -----------|  æµå¼è¾“å‡º
   |<----- event:agent -----------|  ...
   |<----- res (final) -----------|  å®Œæˆ: {runId, status, summary}
```

**è®¤è¯æœºåˆ¶**:

1. **Token è®¤è¯**: `OPENCLAW_GATEWAY_TOKEN` ç¯å¢ƒå˜é‡æˆ– `--token` å‚æ•°
2. **è®¾å¤‡é…å¯¹**: æ–°è®¾å¤‡é¦–æ¬¡è¿æ¥éœ€é€šè¿‡ Admin UI æ‰¹å‡†
3. **æœ¬åœ°ä¿¡ä»»**: å›ç¯åœ°å€è¿æ¥å¯é…ç½®è‡ªåŠ¨æ‰¹å‡†
4. **Tailscale é›†æˆ**: æ”¯æŒ Tailscale èº«ä»½å¤´è®¤è¯

### 4.2 ä¼šè¯ç®¡ç†

```typescript
// ä¼šè¯æ¨¡å‹
interface Session {
  id: string;
  mainKey: string;          // "main" è¡¨ç¤ºä¸»ä¼šè¯
  agentId: string;          // ç»‘å®šçš„ Agent
  channel: string;          // æ¥æºæ¸ é“
  peerId: string;           // å¯¹è¯æ–¹ ID
  messages: Message[];      // å†å²æ¶ˆæ¯
  thinkingLevel: ThinkingLevel;
  model: string;
  sandbox?: SandboxConfig;  // æ²™ç®±é…ç½®
}

// ä¼šè¯è·¯ç”±è§„åˆ™
// 1. ç›´æ¥å¯¹è¯ (DM) â†’ åˆå¹¶åˆ° "main" ä¼šè¯ (å¯é…ç½®)
// 2. ç¾¤ç»„æ¶ˆæ¯ â†’ æ¯ç¾¤ç»„ç‹¬ç«‹ä¼šè¯
// 3. å¤š Agent â†’ æŒ‰ç»‘å®šè·¯ç”±åˆ°ä¸åŒ Agent
```

**ä¼šè¯æŒä¹…åŒ–**:
- ä½ç½®: `~/.openclaw/agents/<agentId>/sessions/sessions.json`
- ç­–ç•¥: å†…å­˜ + å®šæœŸæŒä¹…åŒ–
- è£å‰ª: æ”¯æŒä¸Šä¸‹æ–‡å‹ç¼© (compaction)

### 4.3 æ¶ˆæ¯è·¯ç”±å¼•æ“

```typescript
// è·¯ç”±æµç¨‹
inboundMessage
  â”‚
  â”œâ”€ 1. æ¸ é“è§£æ (WhatsApp/Telegram/...)
  â”‚
  â”œâ”€ 2. å‘é€è€…é‰´æƒ
  â”‚     â”œâ”€ allowFrom ç™½åå•æ£€æŸ¥
  â”‚     â””â”€ dmPolicy: "pairing" | "open"
  â”‚
  â”œâ”€ 3. Agent è·¯ç”±
  â”‚     â””â”€ agents.list[].bindings åŒ¹é…
  â”‚
  â”œâ”€ 4. ä¼šè¯å®šä½/åˆ›å»º
  â”‚     â”œâ”€ DM â†’ main session
  â”‚     â””â”€ Group â†’ group:<groupId>
  â”‚
  â”œâ”€ 5. æ¶ˆæ¯å…¥é˜Ÿ
  â”‚     â””â”€ queue.mode: "fifo" | "latest"
  â”‚
  â””â”€ 6. Agent è°ƒç”¨
        â””â”€ RPC â†’ Pi Agent
```

### 4.4 é…ç½®æ ¡éªŒä¸çƒ­é‡è½½

**ä¸¥æ ¼é…ç½®æ ¡éªŒ**:

OpenClaw é‡‡ç”¨**ä¸¥æ ¼æ‹’ç»æœªçŸ¥é”®**çš„ç­–ç•¥ï¼Œé…ç½®éªŒè¯å¤±è´¥æ—¶ Gateway æ‹’ç»å¯åŠ¨ï¼š

```typescript
// é…ç½®æ ¡éªŒæµç¨‹
validateConfig(rawJson5: string) {
  const parsed = JSON5.parse(rawJson5);
  const schema = Type.Strict(OpenClawConfigSchema);  // TypeBox ä¸¥æ ¼æ¨¡å¼
  
  if (!TypeBoxValidate(schema, parsed)) {
    throw new ConfigValidationError(errors);
    // Gateway æ‹’ç»å¯åŠ¨ï¼Œåªå…è®¸è¯Šæ–­å‘½ä»¤
    // openclaw doctor, openclaw logs, openclaw health
  }
}
```

**é…ç½®çƒ­é‡è½½**:

| æ“ä½œ | RPC æ–¹æ³• | è¡Œä¸º |
|------|----------|------|
| **å…¨é‡æ›¿æ¢** | `config.apply` | æ ¡éªŒ â†’ å†™å…¥ â†’ é‡å¯ Gateway |
| **å¢é‡æ›´æ–°** | `config.patch` | JSON Merge Patch è¯­ä¹‰åˆå¹¶ |
| **UI ç¼–è¾‘** | Control UI | Schema é©±åŠ¨è¡¨å• + Raw JSON ç¼–è¾‘å™¨ |

```typescript
// config.apply å‚æ•°
{
  raw: string;           // JSON5 é…ç½®å†…å®¹
  baseHash?: string;     // ä¹è§‚é”ï¼šé…ç½®å“ˆå¸Œ
  sessionKey?: string;   // é‡å¯åå”¤é†’çš„ä¼šè¯
  restartDelayMs?: number; // é‡å¯å»¶è¿Ÿ (é»˜è®¤ 2000ms)
}
```

**é…ç½®æ–‡ä»¶åŒ…å« ($include)**:

æ”¯æŒæ‹†åˆ†å¤§å‹é…ç½®åˆ°å¤šä¸ªæ–‡ä»¶ï¼š

```json5
// ~/.openclaw/openclaw.json
{
  gateway: { port: 18789 },
  agents: { "$include": "./agents.json5" },  // å•æ–‡ä»¶åŒ…å«
  broadcast: { 
    "$include": [                             // å¤šæ–‡ä»¶æ·±åº¦åˆå¹¶
      "./clients/mueller.json5",
      "./clients/schmidt.json5"
    ]
  }
}
```

---

## 5. Agent è¿è¡Œæ—¶ (Pi Agent)

### 5.1 Agent Loop è®¾è®¡

```typescript
async function agentLoop(session: Session, message: Message) {
  // 1. æ„å»ºç³»ç»Ÿæç¤ºè¯
  const systemPrompt = await buildSystemPrompt(session);
  
  // 2. ä¸Šä¸‹æ–‡ç»„è£…
  const context = await buildContext(session, message);
  
  // 3. æ¨¡å‹è°ƒç”¨ (æ”¯æŒæµå¼)
  const stream = await callModel({
    model: session.model,
    messages: context,
    tools: getAvailableTools(session),
    thinking: session.thinkingLevel,
  });
  
  // 4. æµå¼å¤„ç†
  for await (const block of stream) {
    if (block.type === 'text') {
      emit('agent', { type: 'text', content: block.content });
    } else if (block.type === 'tool_use') {
      // 5. å·¥å…·è°ƒç”¨
      const result = await executeTool(block.tool, block.input, session);
      // 6. å·¥å…·ç»“æœåé¦ˆç»™æ¨¡å‹
      context.push({ role: 'tool', content: result });
      // é€’å½’ç»§ç»­
    }
  }
  
  // 7. å“åº”å‘é€å›æ¸ é“
  await sendToChannel(session.channel, response);
}
```

### 5.2 ç³»ç»Ÿæç¤ºè¯ç»„æˆ

ç³»ç»Ÿæç¤ºè¯ç”± OpenClaw è‡ªè¡Œç»„è£…ï¼ˆä¸ä½¿ç”¨ p-coding-agent é»˜è®¤æç¤ºè¯ï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹å›ºå®šæ®µè½ï¼š

**ç³»ç»Ÿæç¤ºè¯ç»“æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Tooling          - å½“å‰å·¥å…·åˆ—è¡¨ + ç®€çŸ­æè¿°               â”‚
â”‚  2. Skills           - å¯ç”¨æŠ€èƒ½åˆ—è¡¨ (å…ƒæ•°æ®ï¼ŒæŒ‡ä»¤æŒ‰éœ€è¯»å–)   â”‚
â”‚  3. Self-Update      - å¦‚ä½•è¿è¡Œ config.apply / update.run   â”‚
â”‚  4. Workspace        - å·¥ä½œç›®å½•è·¯å¾„                         â”‚
â”‚  5. Documentation    - æœ¬åœ°æ–‡æ¡£è·¯å¾„ + ä½•æ—¶å‚è€ƒæ–‡æ¡£           â”‚
â”‚  6. Sandbox          - æ²™ç®±çŠ¶æ€ + å¯ç”¨çš„ elevated é€‰é¡¹      â”‚
â”‚  7. Current Date     - ç”¨æˆ·æ—¶åŒºæ—¶é—´ + æ—¶é—´æ ¼å¼              â”‚
â”‚  8. Reply Tags       - å¹³å°ç‰¹å®šå›å¤æ ‡ç­¾è¯­æ³•                 â”‚
â”‚  9. Runtime          - ç‰ˆæœ¬ + ä»“åº“æ ¹ç›®å½•                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  10. Project Context - æ³¨å…¥çš„å·¥ä½œåŒºæ–‡ä»¶ (Bootstrap Files)    â”‚
â”‚      â”œâ”€â”€ AGENTS.md      è¡Œä¸ºæŒ‡å—                            â”‚
â”‚      â”œâ”€â”€ SOUL.md        äººæ ¼/è¯­æ°”/è¾¹ç•Œ                       â”‚
â”‚      â”œâ”€â”€ TOOLS.md       å·¥å…·ä½¿ç”¨ç¬”è®°                        â”‚
â”‚      â”œâ”€â”€ IDENTITY.md    èº«ä»½åç§°/emoji                      â”‚
â”‚      â”œâ”€â”€ USER.md        ç”¨æˆ·æ¡£æ¡ˆ                            â”‚
â”‚      â”œâ”€â”€ HEARTBEAT.md   å¿ƒè·³ä»»åŠ¡æ¸…å•                        â”‚
â”‚      â””â”€â”€ BOOTSTRAP.md   é¦–æ¬¡è¿è¡Œä»ªå¼ (å®Œæˆååˆ é™¤)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Bootstrap æ–‡ä»¶å¤„ç†**:

```typescript
// æ³¨å…¥ç­–ç•¥
interface BootstrapInjection {
  maxCharsPerFile: 20000;           // agents.defaults.bootstrapMaxChars
  truncationMarker: "[TRUNCATED]";  // è¶…é•¿æ–‡ä»¶æˆªæ–­æ ‡è®°
  missingMarker: "[FILE MISSING]";  // ç¼ºå¤±æ–‡ä»¶æç¤º
  loadOrder: ["AGENTS", "SOUL", "TOOLS", "IDENTITY", "USER", "HEARTBEAT", "BOOTSTRAP"];
}

// Prompt æ¨¡å¼
type PromptMode = 
  | "full"     // å®Œæ•´æç¤ºè¯ (é»˜è®¤)
  | "minimal"  // å­ Agent ç”¨ï¼Œçœç•¥ Skills/Memory/Messaging ç­‰
  | "none";    // ä»…è¿”å›åŸºç¡€èº«ä»½è¡Œ
```

**å·¥ä½œåŒºç›®å½•ç»“æ„**:

```
~/.openclaw/workspace/           # agents.defaults.workspace
â”œâ”€â”€ AGENTS.md                    # Agent è¡Œä¸ºæŒ‡å—
â”œâ”€â”€ SOUL.md                      # äººæ ¼/è¯­æ°”è®¾å®š
â”œâ”€â”€ TOOLS.md                     # å·¥å…·ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ IDENTITY.md                  # èº«ä»½ä¿¡æ¯
â”œâ”€â”€ USER.md                      # ç”¨æˆ·åå¥½
â”œâ”€â”€ BOOTSTRAP.md                 # å¯åŠ¨è¯´æ˜ (é¦–æ¬¡è¿è¡Œ)
â”œâ”€â”€ HEARTBEAT.md                 # å¿ƒè·³ä»»åŠ¡ (å¯é€‰)
â”œâ”€â”€ BOOT.md                      # å¯åŠ¨æ£€æŸ¥æ¸…å• (å¯é€‰)
â”‚
â”œâ”€â”€ memory/                      # æŒä¹…è®°å¿†
â”‚   â”œâ”€â”€ MEMORY.md               # é•¿æœŸè®°å¿†ç²¾å (ä¸»ä¼šè¯ä¸“ç”¨)
â”‚   â”œâ”€â”€ 2026-01-31.md           # æ¯æ—¥æ—¥å¿—
â”‚   â””â”€â”€ topics/                 # ä¸»é¢˜è®°å¿†
â”‚
â”œâ”€â”€ skills/                      # å·¥ä½œåŒºæŠ€èƒ½ (æœ€é«˜ä¼˜å…ˆçº§)
â”‚   â””â”€â”€ custom-skill/
â”‚       â””â”€â”€ SKILL.md
â”‚
â””â”€â”€ canvas/                      # A2UI å¯è§†åŒ–æ–‡ä»¶
```

**è®°å¿†ç³»ç»Ÿ**:

| æ–‡ä»¶ | ä½œç”¨åŸŸ | è®¿é—®è§„åˆ™ |
|------|--------|----------|
| `MEMORY.md` | ä»…ä¸»ä¼šè¯ | å®‰å…¨è€ƒè™‘ï¼šä¸å‘é™Œç”Ÿäººæ³„éœ² |
| `memory/YYYY-MM-DD.md` | æ‰€æœ‰ä¼šè¯ | æ¯æ—¥æ—¥å¿—ï¼Œå»ºè®®è¯»å–ä»Šå¤©+æ˜¨å¤© |
| `memory/topics/*.md` | æ‰€æœ‰ä¼šè¯ | ä¸»é¢˜ç´¢å¼•è®°å¿† |

### 5.3 Agent Loop è¯¦ç»†æµç¨‹

```typescript
// å®Œæ•´ Agent Loop
async function agentLoop(session: Session, message: Message) {
  // 1. å…¥å£éªŒè¯
  const { runId, acceptedAt } = await validateAndAccept(session, message);
  emit('lifecycle', { phase: 'accepted', runId });
  
  // 2. ä¼šè¯é” + é˜Ÿåˆ—ç®¡ç†
  await acquireSessionLane(session.key);  // ä¸²è¡ŒåŒ–åŒä¸€ä¼šè¯
  
  // 3. å·¥ä½œåŒºå‡†å¤‡
  const workspace = resolveWorkspace(session);
  if (session.sandbox.mode !== 'off') {
    workspace = createSandboxWorkspace(session);
  }
  
  // 4. æŠ€èƒ½å¿«ç…§
  const skills = snapshotEligibleSkills(session.agentId);
  injectSkillsEnv(skills);  // æ³¨å…¥ç¯å¢ƒå˜é‡
  
  // 5. ç³»ç»Ÿæç¤ºè¯æ„å»º
  const systemPrompt = await buildSystemPrompt({
    mode: session.promptMode || 'full',
    workspace,
    skills,
    sandbox: session.sandbox,
    bootstrapFiles: await loadBootstrapFiles(workspace),
  });
  
  // 6. ä¸Šä¸‹æ–‡ç»„è£…
  const context = await buildContext(session, message, {
    historyLimit: session.historyLimit,
    pruneToolResults: session.contextPruning,
  });
  
  // 7. æ¨¡å‹è°ƒç”¨ (æµå¼)
  const stream = await callModel({
    model: session.model,
    systemPrompt,
    messages: context,
    tools: getAvailableTools(session),
    thinking: session.thinkingLevel,
  });
  
  // 8. æµå¼å¤„ç†
  for await (const block of stream) {
    switch (block.type) {
      case 'text':
        emit('agent', { type: 'assistant', content: block.content });
        break;
        
      case 'tool_use':
        emit('agent', { type: 'tool_start', tool: block.tool });
        
        // 9. å·¥å…·æ‰§è¡Œ
        const result = await executeTool(block.tool, block.input, {
          session,
          sandbox: session.sandbox,
          elevated: session.elevatedMode,
        });
        
        emit('agent', { type: 'tool_end', tool: block.tool, result });
        
        // 10. æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ— (steer æ¨¡å¼)
        if (session.queueMode === 'steer' && hasQueuedMessage(session)) {
          skipRemainingToolCalls();
          injectQueuedMessage();
        }
        break;
    }
  }
  
  // 11. å›å¤æ•´å½¢
  const payloads = shapeReply(stream.output, {
    suppressDuplicates: true,    // å»é‡æ¶ˆæ¯å·¥å…·å‘é€
    filterNoReply: true,         // è¿‡æ»¤ NO_REPLY æ ‡è®°
  });
  
  // 12. è‡ªåŠ¨å‹ç¼©æ£€æµ‹
  if (shouldCompact(session)) {
    await performCompaction(session);
    emit('lifecycle', { phase: 'compaction' });
  }
  
  // 13. å‘é€å“åº”
  await sendToChannel(session.channel, payloads);
  
  // 14. æŒä¹…åŒ–
  await persistSession(session);
  emit('lifecycle', { phase: 'complete', runId });
}
```

**é˜Ÿåˆ—æ¨¡å¼**:

| æ¨¡å¼ | è¡Œä¸º |
|------|------|
| `collect` | ç­‰å¾…å½“å‰ turn ç»“æŸï¼Œæ–°æ¶ˆæ¯åˆå¹¶åˆ°ä¸‹ä¸€ turn |
| `steer` | ä¸­æ–­å½“å‰å·¥å…·è°ƒç”¨ï¼Œæ³¨å…¥æ–°æ¶ˆæ¯ |
| `followup` | ç­‰å¾…ç»“æŸåå¯åŠ¨æ–° turn |
| `interrupt` | ç›´æ¥ä¸­æ–­å½“å‰ run |

### 5.4 å·¥å…·ç³»ç»Ÿ

**å†…ç½®å·¥å…·åˆ†ç±»**:

| å·¥å…·å | åŠŸèƒ½ | å®‰å…¨ç­‰çº§ | æ²™ç®±è¡Œä¸º |
|--------|------|----------|----------|
| `exec` | Shell å‘½ä»¤æ‰§è¡Œ | ğŸ”´ é«˜å± | å®¹å™¨å†…æ‰§è¡Œ (é»˜è®¤) |
| `process` | è¿›ç¨‹ç®¡ç† | ğŸ”´ é«˜å± | å®¹å™¨å†…æ‰§è¡Œ |
| `write` | æ–‡ä»¶å†™å…¥ | ğŸ”´ é«˜å± | æ²™ç®±å·¥ä½œåŒº |
| `edit` | æ–‡ä»¶ç¼–è¾‘ | ğŸ”´ é«˜å± | æ²™ç®±å·¥ä½œåŒº |
| `apply_patch` | è¡¥ä¸åº”ç”¨ | ğŸ”´ é«˜å± | å¯é€‰å·¥å…· |
| `browser` | CDP æµè§ˆå™¨æ§åˆ¶ | ğŸ”´ é«˜å± | å¯é…ç½®æ²™ç®±æµè§ˆå™¨ |
| `read` | æ–‡ä»¶è¯»å– | ğŸŸ¡ ä¸­ç­‰ | æ²™ç®±å·¥ä½œåŒºæ ¹ç›®å½• |
| `web_fetch` | ç½‘é¡µè·å– | ğŸŸ¡ ä¸­ç­‰ | - |
| `cron` | å®šæ—¶ä»»åŠ¡ | ğŸŸ¡ ä¸­ç­‰ | - |
| `nodes` | è®¾å¤‡æ§åˆ¶ | ğŸŸ¡ ä¸­ç­‰ | èŠ‚ç‚¹éœ€å•ç‹¬æ‰¹å‡† |
| `canvas` | A2UI å¯è§†åŒ– | ğŸŸ¢ ä½å± | - |
| `sessions_*` | å¤šä¼šè¯åä½œ | ğŸŸ¢ ä½å± | - |
| `web_search` | ç½‘é¡µæœç´¢ | ğŸŸ¢ ä½å± | - |
| `image` | å›¾åƒç”Ÿæˆ | ğŸŸ¢ ä½å± | - |

**å·¥å…·ç­–ç•¥å±‚çº§**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: tools.elevated (å…¨å±€æå‡ç™½åå•)                    â”‚
â”‚           - å…è®¸æ²™ç®±å†…å·¥å…·åœ¨å®¿ä¸»æœºæ‰§è¡Œ                        â”‚
â”‚           - éœ€è¦å‘é€è€…åœ¨ tools.elevated.allowFrom ç™½åå•     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: agents.list[].tools (Agent çº§åˆ«ç­–ç•¥)               â”‚
â”‚           - allow: å…è®¸çš„å·¥å…·åˆ—è¡¨                            â”‚
â”‚           - deny: æ‹’ç»çš„å·¥å…·åˆ—è¡¨ (deny ä¼˜å…ˆ)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: tools.sandbox.tools (æ²™ç®±å†…å·¥å…·ç­–ç•¥)               â”‚
â”‚           - é™åˆ¶æ²™ç®±å†…å¯ç”¨çš„å·¥å…·                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 4: exec.approvals (æ‰§è¡Œæ‰¹å‡†)                         â”‚
â”‚           - é«˜å±å‘½ä»¤éœ€è¦ç”¨æˆ·äº¤äº’æ‰¹å‡†                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥å…·ç»„å¿«æ·æ–¹å¼**:

```typescript
// é…ç½®æ”¯æŒ group:* å±•å¼€
const toolGroups = {
  "group:filesystem": ["read", "write", "edit", "apply_patch"],
  "group:sessions": ["sessions_list", "sessions_history", "sessions_send", "sessions_spawn", "session_status"],
  "group:messaging": ["whatsapp", "telegram", "slack", "discord"],
};

// ç¤ºä¾‹é…ç½®
{
  tools: {
    allow: ["group:filesystem", "exec"],
    deny: ["browser"]
  }
}
```

### 5.5 æŠ€èƒ½ç³»ç»Ÿ (Skills)

æŠ€èƒ½æ˜¯ **AgentSkills è§„èŒƒ** å…¼å®¹çš„ç›®å½•ï¼ŒåŒ…å« `SKILL.md` åŠç›¸å…³æ–‡ä»¶ã€‚

**æŠ€èƒ½åŠ è½½ä¼˜å…ˆçº§**:

```
1. å·¥ä½œåŒºæŠ€èƒ½: <workspace>/skills/          (æœ€é«˜ä¼˜å…ˆçº§)
2. æœ¬åœ°æŠ€èƒ½:   ~/.openclaw/skills/          (ç”¨æˆ·è‡ªå®šä¹‰)
3. å†…ç½®æŠ€èƒ½:   <package>/skills/            (æ†ç»‘å‘å¸ƒ)
4. æ‰©å±•ç›®å½•:   skills.load.extraDirs        (é…ç½®æŒ‡å®š)
```

**SKILL.md æ ¼å¼**:

```yaml
---
name: nano-banana-pro
description: Generate or edit images via Gemini 3 Pro Image
metadata: {"openclaw":{"requires":{"bins":["uv"],"env":["GEMINI_API_KEY"]},"primaryEnv":"GEMINI_API_KEY"}}
user-invocable: true
disable-model-invocation: false
---

# æŠ€èƒ½æŒ‡ä»¤

ä½¿ç”¨ `{baseDir}` å¼•ç”¨æŠ€èƒ½ç›®å½•è·¯å¾„...
```

**æŠ€èƒ½é—¨æ§ (Gating)**:

| å­—æ®µ | ä½œç”¨ |
|------|------|
| `requires.bins` | éœ€è¦çš„äºŒè¿›åˆ¶ (åŠ è½½æ—¶æ£€æŸ¥) |
| `requires.env` | éœ€è¦çš„ç¯å¢ƒå˜é‡ |
| `requires.config` | éœ€è¦çš„é…ç½®é”® |
| `os` | å¹³å°é™åˆ¶ (darwin/linux/win32) |

**æŠ€èƒ½ Token å½±å“**:

```
åŸºç¡€å¼€é”€ (â‰¥1 æŠ€èƒ½æ—¶): ~195 å­—ç¬¦
æ¯æŠ€èƒ½å¼€é”€: ~(4 + name.length + description.length) å­—ç¬¦

ç¤ºä¾‹: 12 ä¸ªæŠ€èƒ½ â†’ ~2,184 å­—ç¬¦ (~546 token)
```

**æŠ€èƒ½å¿«ç…§æœºåˆ¶**:

æŠ€èƒ½åœ¨ä¼šè¯é¦–æ¬¡å¯åŠ¨æ—¶å¿«ç…§ï¼Œåç»­ turn å¤ç”¨ã€‚æ–‡ä»¶ç›‘æ§å¯é€‰ (skills.load.watch)ï¼Œæ£€æµ‹ SKILL.md å˜æ›´ååˆ·æ–°å¿«ç…§ã€‚

**å·¥å…·æƒé™æ§åˆ¶**:

```json
{
  "agents": {
    "list": [{
      "id": "public-agent",
      "tools": {
        "allow": ["read", "sessions_list", "sessions_send"],
        "deny": ["exec", "browser", "write", "edit"]
      }
    }]
  }
}
```

---

## 6. æ¸ é“é›†æˆæ¶æ„

### 6.1 æ¸ é“æŠ½è±¡å±‚

```typescript
// æ¸ é“æ¥å£å®šä¹‰
interface Channel {
  id: string;
  type: ChannelType;
  
  // ç”Ÿå‘½å‘¨æœŸ
  connect(): Promise<void>;
  disconnect(): Promise<void>;
  
  // æ¶ˆæ¯æ”¶å‘
  onMessage(handler: MessageHandler): void;
  send(peerId: string, message: OutboundMessage): Promise<void>;
  
  // çŠ¶æ€
  getPresence(): PresenceInfo;
  setTyping(peerId: string, typing: boolean): void;
}

// æ¶ˆæ¯æ ‡å‡†åŒ–
interface InboundMessage {
  id: string;
  channel: string;
  peerId: string;
  groupId?: string;
  content: MessageContent;
  timestamp: number;
  replyTo?: string;
  attachments?: Attachment[];
}
```

### 6.2 WhatsApp é›†æˆ (Baileys)

```typescript
// å…³é”®å®ç°ç‚¹
class WhatsAppChannel implements Channel {
  private sock: WASocket;
  
  async connect() {
    // 1. åŠ è½½/åˆ›å»ºè®¤è¯çŠ¶æ€
    const { state, saveCreds } = await useMultiFileAuthState(
      '~/.openclaw/credentials/whatsapp'
    );
    
    // 2. åˆ›å»ºè¿æ¥
    this.sock = makeWASocket({
      auth: state,
      printQRInTerminal: true,  // é¦–æ¬¡éœ€æ‰«ç 
    });
    
    // 3. ç›‘å¬äº‹ä»¶
    this.sock.ev.on('messages.upsert', this.handleMessage);
    this.sock.ev.on('creds.update', saveCreds);
  }
  
  // âš ï¸ é‡è¦ï¼šæ¯ä¸»æœºåªèƒ½æœ‰ä¸€ä¸ª WhatsApp Web ä¼šè¯
}
```

### 6.3 Telegram é›†æˆ (grammY)

```typescript
class TelegramChannel implements Channel {
  private bot: Bot;
  
  async connect() {
    this.bot = new Bot(process.env.TELEGRAM_BOT_TOKEN);
    
    // æ”¯æŒ Webhook æˆ–é•¿è½®è¯¢
    if (this.config.webhookUrl) {
      await this.bot.api.setWebhook(this.config.webhookUrl);
    } else {
      this.bot.start();  // é•¿è½®è¯¢
    }
    
    this.bot.on('message', this.handleMessage);
  }
  
  // ç‰¹æ€§ï¼šæ”¯æŒè‰ç¨¿æµå¼è¾“å‡º (editMessageText)
}
```

### 6.4 æ‰©å±•æ¸ é“æœºåˆ¶

æ‰©å±•ä½äº `extensions/` ç›®å½•ï¼Œä½œä¸ºç‹¬ç«‹ npm åŒ…ï¼š

```typescript
// extensions/msteams/index.ts
export default class MSTeamsPlugin implements ChannelPlugin {
  static id = 'msteams';
  static configSchema = MSTeamsConfigSchema;
  
  async activate(gateway: Gateway) {
    // æ³¨å†Œæ¸ é“
    gateway.registerChannel(new MSTeamsChannel(this.config));
  }
}
```

**æ’ä»¶åŠ è½½æµç¨‹**:
1. æ‰«æ `extensions/*/package.json`
2. `npm install --omit=dev` å®‰è£…ä¾èµ–
3. åŠ¨æ€ import å¹¶è°ƒç”¨ `activate()`

---

## 7. å®‰å…¨æ¶æ„

### 7.1 æ²™ç®±æ¨¡å¼è¯¦è§£

```typescript
// å®Œæ•´æ²™ç®±é…ç½®
interface SandboxConfig {
  mode: "off" | "non-main" | "all";
  // off: ç¦ç”¨æ²™ç®±ï¼Œå·¥å…·ç›´æ¥åœ¨å®¿ä¸»æ‰§è¡Œ
  // non-main: éä¸»ä¼šè¯ (ç¾¤ç»„ç­‰) å¯ç”¨æ²™ç®±
  // all: æ‰€æœ‰ä¼šè¯éƒ½å¯ç”¨æ²™ç®±
  
  scope: "session" | "agent" | "shared";
  // session: æ¯ä¼šè¯ç‹¬ç«‹å®¹å™¨
  // agent: æ¯ Agent å…±äº«ä¸€ä¸ªå®¹å™¨
  // shared: å…¨å±€å…±äº«å®¹å™¨
  
  workspaceAccess: "none" | "ro" | "rw";
  // none: æ²™ç®±æ— æ³•è®¿é—®å·¥ä½œåŒº
  // ro: åªè¯»æŒ‚è½½å·¥ä½œåŒºåˆ° /agent
  // rw: è¯»å†™æŒ‚è½½å·¥ä½œåŒºåˆ° /workspace
  
  docker?: {
    image: string;              // è‡ªå®šä¹‰é•œåƒ
    network: "none" | "host" | "bridge";
    env: Record<string, string>; // æ³¨å…¥ç¯å¢ƒå˜é‡
    setupCommand?: string;      // å®¹å™¨åˆ›å»ºåæ‰§è¡Œ
    binds?: string[];           // é¢å¤–æŒ‚è½½
  };
  
  browser?: {
    autoStart: boolean;         // è‡ªåŠ¨å¯åŠ¨æ²™ç®±æµè§ˆå™¨
    allowHostControl: boolean;  // å…è®¸æ§åˆ¶å®¿ä¸»æµè§ˆå™¨
  };
  
  prune?: {
    enabled: boolean;           // å®šæœŸæ¸…ç†å®¹å™¨
    maxAgeMs: number;
  };
}
```

**æ²™ç®±æ¶æ„å›¾**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gateway (å®¿ä¸»æœº)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Session Manager                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ main session      â†’ æ²™ç®±: off (ç›´æ¥å®¿ä¸»æ‰§è¡Œ)          â”‚  â”‚
â”‚  â”‚  â”œâ”€ group:xxx session â†’ æ²™ç®±: Docker Container A          â”‚  â”‚
â”‚  â”‚  â””â”€ group:yyy session â†’ æ²™ç®±: Docker Container B          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚              â–¼                               â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Sandbox Container  â”‚         â”‚  Sandbox Container  â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚ /workspace    â”‚  â”‚         â”‚  â”‚ /workspace    â”‚  â”‚       â”‚
â”‚  â”‚  â”‚ (éš”ç¦»å·¥ä½œåŒº)  â”‚  â”‚         â”‚  â”‚ (éš”ç¦»å·¥ä½œåŒº)  â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚ /agent (ro)   â”‚  â”‚         â”‚  â”‚ /agent (ro)   â”‚  â”‚       â”‚
â”‚  â”‚  â”‚ (åŸå§‹å·¥ä½œåŒº)  â”‚  â”‚         â”‚  â”‚ (åŸå§‹å·¥ä½œåŒº)  â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ²™ç®±å†…å·¥å…·è¡Œä¸º**:

| å·¥å…· | æ²™ç®±è¡Œä¸º |
|------|----------|
| `exec` | sh -lc åœ¨å®¹å™¨å†…æ‰§è¡Œï¼Œenv.PATH å·²æ³¨å…¥ |
| `read` | æ ¹ç›®å½•ä¸ºæ²™ç®±å·¥ä½œåŒº |
| `write/edit` | åªåœ¨ workspaceAccess=rw æ—¶å¯ç”¨ |
| `browser` | å¯é…ç½®ä½¿ç”¨æ²™ç®±æµè§ˆå™¨æˆ–å®¿ä¸»æµè§ˆå™¨ |
| `process` | åªèƒ½ç®¡ç†å®¹å™¨å†…è¿›ç¨‹ |

### 7.2 Elevated æ¨¡å¼

å½“æ²™ç®±å¯ç”¨æ—¶ï¼Œ`/elevated` æŒ‡ä»¤å…è®¸**ä¸´æ—¶æå‡**åˆ°å®¿ä¸»æ‰§è¡Œï¼š

```typescript
// Elevated çº§åˆ«
type ElevatedMode = 
  | "off"   // ç¦ç”¨ï¼Œä¿æŒæ²™ç®±
  | "on"    // å…è®¸å®¿ä¸»æ‰§è¡Œï¼Œéœ€æ‰¹å‡†
  | "ask"   // æ¯æ¬¡è¯¢é—®
  | "full"; // å…è®¸å®¿ä¸»æ‰§è¡Œï¼Œè·³è¿‡æ‰¹å‡†

// ä½¿ç”¨æ–¹å¼
"/elevated on"        // ä¼šè¯çº§åˆ«è®¾ç½®
"/elevated full"      // æ¶ˆæ¯çº§åˆ«å†…è”
```

**Elevated é—¨æ§æ£€æŸ¥**:

1. `tools.elevated.enabled` å…¨å±€å¼€å…³
2. `tools.elevated.allowFrom.<channel>` å‘é€è€…ç™½åå•
3. `agents.list[].tools.elevated` Agent çº§åˆ«é™åˆ¶
4. ä¸‰å±‚æ£€æŸ¥å…¨éƒ¨é€šè¿‡æ‰å…è®¸æå‡

### 7.3 å®‰å…¨é»˜è®¤å€¼

| è®¾ç½® | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `gateway.bind` | `"loopback"` | ä»…ç›‘å¬ 127.0.0.1 |
| `dmPolicy` | `"pairing"` | é™Œç”Ÿäººéœ€é…å¯¹ç ç¡®è®¤ |
| `groupPolicy` | `"allowlist"` | ç¾¤ç»„éœ€ç™½åå• |
| `tools.exec.host` | `"sandbox"` | Shell é»˜è®¤åœ¨æ²™ç®±æ‰§è¡Œ |
| `gateway.auth.mode` | `"token"` | éœ€è¦ Token è®¤è¯ |

### 7.4 å¤š Agent è·¯ç”±ä¸éš”ç¦»

OpenClaw æ”¯æŒåœ¨å•ä¸ª Gateway å†…è¿è¡Œ**å¤šä¸ªéš”ç¦»çš„ Agent**ï¼Œæ¯ä¸ª Agent æœ‰ç‹¬ç«‹çš„ï¼š
- å·¥ä½œåŒº (workspace)
- ä¼šè¯å­˜å‚¨ (agentDir)
- æ²™ç®±é…ç½®
- å·¥å…·æƒé™

**è·¯ç”±ç»‘å®š**:

```json5
{
  agents: {
    list: [
      { id: "main", default: true, workspace: "~/.openclaw/workspace" },
      { id: "work", workspace: "~/.openclaw/workspace-work" },
      { id: "family", workspace: "~/.openclaw/workspace-family", 
        sandbox: { mode: "all", scope: "agent" },
        tools: { allow: ["read"], deny: ["exec", "browser"] }
      }
    ]
  },
  bindings: [
    // ç²¾ç¡®åŒ¹é…ï¼šç‰¹å®šç¾¤ç»„ â†’ family agent
    { agentId: "family", match: { channel: "whatsapp", peer: { kind: "group", id: "[email protected]" } } },
    // è´¦å·åŒ¹é…ï¼šå·¥ä½œå¾®ä¿¡è´¦å· â†’ work agent  
    { agentId: "work", match: { channel: "whatsapp", accountId: "biz" } },
    // é€šé…åŒ¹é…ï¼šæ‰€æœ‰ Telegram æ¶ˆæ¯ â†’ work agent
    { agentId: "work", match: { channel: "telegram", accountId: "*" } },
  ]
}
```

**ç»‘å®šåŒ¹é…ä¼˜å…ˆçº§** (ä»é«˜åˆ°ä½):

1. `match.peer` (ç‰¹å®š DM/ç¾¤ç»„)
2. `match.guildId` (Discord æœåŠ¡å™¨)
3. `match.teamId` (Slack å›¢é˜Ÿ)
4. `match.accountId` (ç²¾ç¡®è´¦å·)
5. `match.accountId: "*"` (æ¸ é“é€šé…)
6. é»˜è®¤ Agent

### 7.5 å·²çŸ¥å®‰å…¨é£é™©

âš ï¸ **æç¤ºæ³¨å…¥**: Agent è¯»å–ä¸å¯ä¿¡å†…å®¹ï¼ˆç½‘é¡µ/é‚®ä»¶ï¼‰æ—¶å¯èƒ½è¢«è¯±å¯¼æ‰§è¡Œæ¶æ„æŒ‡ä»¤

âš ï¸ **æƒé™æ‰©æ•£**: æµè§ˆå™¨æ§åˆ¶å¯è®¿é—®å·²ç™»å½•ä¼šè¯çš„æ‰€æœ‰æ•°æ®

âš ï¸ **é…ç½®æ³„éœ²**: `~/.openclaw/credentials/` å­˜å‚¨æ˜æ–‡å‡­æ®

**ç¼“è§£å»ºè®®**:
1. ä½¿ç”¨ `Anthropic Opus 4.5`ï¼ˆæç¤ºæ³¨å…¥é˜²å¾¡æ›´å¼ºï¼‰
2. æµè§ˆå™¨ä½¿ç”¨ç‹¬ç«‹ Profile
3. æ²™ç®±æ¨¡å¼å¯ç”¨
4. æœ€å°æƒé™å·¥å…·ç™½åå•

---

## 8. æ‰©å±•æœºåˆ¶

### 8.1 Hook ç³»ç»Ÿ

OpenClaw æä¾›ä¸¤ç§ Hook æ‰©å±•ç‚¹ï¼š

**å†…éƒ¨ Hook (Gateway å±‚)**:

| Hook | è§¦å‘æ—¶æœº | ç”¨é€” |
|------|----------|------|
| `agent:bootstrap` | ç³»ç»Ÿæç¤ºè¯æ„å»ºå‰ | ä¿®æ”¹/æ›¿æ¢ Bootstrap æ–‡ä»¶ |
| `/new`, `/reset`, `/stop` | å‘½ä»¤æ‰§è¡Œæ—¶ | å‘½ä»¤ç”Ÿå‘½å‘¨æœŸ |

**æ’ä»¶ Hook (Agent ç”Ÿå‘½å‘¨æœŸ)**:

| Hook | è§¦å‘æ—¶æœº | ç”¨é€” |
|------|----------|------|
| `before_agent_start` | Agent è¿è¡Œå¼€å§‹å‰ | æ³¨å…¥ä¸Šä¸‹æ–‡/è¦†ç›–ç³»ç»Ÿæç¤ºè¯ |
| `agent_end` | Agent è¿è¡Œç»“æŸå | æ£€æŸ¥æœ€ç»ˆæ¶ˆæ¯/å…ƒæ•°æ® |
| `before_compaction` | å‹ç¼©å¼€å§‹å‰ | è§‚å¯Ÿ/æ ‡æ³¨ |
| `after_compaction` | å‹ç¼©å®Œæˆå | è§‚å¯Ÿ/æ ‡æ³¨ |
| `before_tool_call` | å·¥å…·è°ƒç”¨å‰ | æ‹¦æˆª/ä¿®æ”¹å‚æ•° |
| `after_tool_call` | å·¥å…·è°ƒç”¨å | æ‹¦æˆª/ä¿®æ”¹ç»“æœ |
| `tool_result_persist` | å·¥å…·ç»“æœæŒä¹…åŒ–å‰ | åŒæ­¥è½¬æ¢ç»“æœ |
| `message_received` | æ”¶åˆ°æ¶ˆæ¯æ—¶ | å…¥ç«™å¤„ç† |
| `message_sending` | å‘é€æ¶ˆæ¯å‰ | å‡ºç«™å¤„ç† |
| `message_sent` | å‘é€æ¶ˆæ¯å | å‡ºç«™ç¡®è®¤ |

### 8.2 Webhook è¡¨é¢

Gateway æ”¯æŒ HTTP Webhook ç”¨äºå¤–éƒ¨è§¦å‘ï¼š

```typescript
// Webhook é…ç½®
{
  hooks: {
    enabled: true,
    token: "webhook-secret-token",  // è®¤è¯
    endpoints: {
      // POST /hooks/trigger
      trigger: {
        enabled: true,
        allowedEvents: ["custom:*"]
      }
    }
  }
}
```

**ç”¨ä¾‹**:
- Gmail Pub/Sub è§¦å‘
- CI/CD é€šçŸ¥
- æ—¥å†äº‹ä»¶
- IoT è®¾å¤‡äº‹ä»¶

### 8.3 Cron å®šæ—¶ä»»åŠ¡

```json5
{
  cron: {
    jobs: [
      {
        id: "daily-summary",
        schedule: "0 9 * * *",        // Cron è¡¨è¾¾å¼
        agentId: "main",              // ç›®æ ‡ Agent
        sessionKey: "agent:main:cron:daily",
        message: "Generate daily summary",
        enabled: true
      }
    ]
  }
}
```

### 8.4 Heartbeat å¿ƒè·³

å¿ƒè·³æ˜¯ç‰¹æ®Šçš„å®šæ—¶ Agent è°ƒç”¨ï¼Œç”¨äºä¸»åŠ¨ä»»åŠ¡ï¼š

```json5
{
  heartbeat: {
    enabled: true,
    every: "55m",                     // é—´éš” (å­—ç¬¦ä¸²æˆ–æ¯«ç§’)
    agentId: "main",
    prompt: "Read HEARTBEAT.md if it exists. Follow it strictly."
  }
}
```

**å¿ƒè·³ vs Cron**:

| ç‰¹æ€§ | Heartbeat | Cron |
|------|-----------|------|
| çµæ´»åº¦ | å›ºå®šé—´éš” | Cron è¡¨è¾¾å¼ |
| ä¼šè¯ | ä¸»ä¼šè¯ | ä»»æ„ä¼šè¯ |
| ç”¨é€” | ä¿æŒç¼“å­˜çƒ­/æ£€æŸ¥ä»»åŠ¡ | å®šæ—¶ä»»åŠ¡ |
| Token æ¶ˆè€— | æ¯æ¬¡å®Œæ•´ Agent turn | æ¯æ¬¡å®Œæ•´ Agent turn |

---

## 9. éƒ¨ç½²æ¶æ„

### 9.1 æœ¬åœ°éƒ¨ç½²

```bash
# æœ€ç®€å®‰è£…
npm install -g openclaw@latest
openclaw onboard --install-daemon

# ä»æºç 
git clone https://github.com/openclaw/openclaw.git
cd openclaw
pnpm install
pnpm ui:build
pnpm build
pnpm openclaw onboard --install-daemon
```

**è¿›ç¨‹ç®¡ç†**:
- macOS: `launchd` ç”¨æˆ·æœåŠ¡
- Linux: `systemd` ç”¨æˆ·æœåŠ¡
- å®ˆæŠ¤è¿›ç¨‹è‡ªåŠ¨é‡å¯

### 9.2 ä¸Šä¸‹æ–‡çª—å£ä¸å‹ç¼©

**ä¸Šä¸‹æ–‡ç»„æˆ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  System Prompt (OpenClaw æ„å»º)                              â”‚
â”‚  â”œâ”€â”€ å·¥å…·åˆ—è¡¨ + æè¿°                                        â”‚
â”‚  â”œâ”€â”€ æŠ€èƒ½åˆ—è¡¨ (å…ƒæ•°æ®)                                      â”‚
â”‚  â”œâ”€â”€ å·¥ä½œåŒº + Bootstrap æ–‡ä»¶                               â”‚
â”‚  â””â”€â”€ æ—¶é—´/è¿è¡Œæ—¶/æ²™ç®±çŠ¶æ€                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Conversation History                                       â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·æ¶ˆæ¯                                               â”‚
â”‚  â””â”€â”€ Assistant æ¶ˆæ¯                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tool Calls/Results                                         â”‚
â”‚  â”œâ”€â”€ å‘½ä»¤è¾“å‡º                                               â”‚
â”‚  â”œâ”€â”€ æ–‡ä»¶è¯»å–å†…å®¹                                           â”‚
â”‚  â””â”€â”€ å›¾åƒ/é™„ä»¶ (base64)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŸ¥çœ‹ä¸Šä¸‹æ–‡ä½¿ç”¨**:

```bash
/status          # å¿«é€ŸæŸ¥çœ‹çª—å£ä½¿ç”¨ç‡
/context list    # æ³¨å…¥å†…å®¹ + å¤§è‡´å¤§å°
/context detail  # è¯¦ç»†åˆ†è§£ (æ¯æ–‡ä»¶/æ¯å·¥å…·/æ¯æŠ€èƒ½)
/usage tokens    # æ¯å›å¤è¿½åŠ  Token ä½¿ç”¨
```

**è‡ªåŠ¨å‹ç¼© (Compaction)**:

å½“ä¸Šä¸‹æ–‡æ¥è¿‘çª—å£é™åˆ¶æ—¶ï¼ŒOpenClaw è‡ªåŠ¨å‹ç¼©å†å²ï¼š

```typescript
// å‹ç¼©é…ç½®
{
  agents: {
    defaults: {
      compaction: {
        mode: "safeguard",                    // off | safeguard | aggressive
        reserveTokensFloor: 24000,            // ä¿ç•™çª—å£ç©ºé—´
        memoryFlush: {
          enabled: true,
          softThresholdTokens: 6000,          // è§¦å‘é˜ˆå€¼
          systemPrompt: "Session nearing compaction...",
          prompt: "Write any lasting notes to memory/YYYY-MM-DD.md"
        }
      }
    }
  }
}
```

**å‹ç¼©æµç¨‹**:

1. æ£€æµ‹åˆ°ä¸Šä¸‹æ–‡æ¥è¿‘é™åˆ¶
2. è§¦å‘ `memoryFlush` è®© Agent ä¿å­˜é‡è¦ä¿¡æ¯
3. ç”Ÿæˆå†å²æ‘˜è¦
4. æ›¿æ¢è¯¦ç»†å†å²ä¸ºå‹ç¼©æ‘˜è¦
5. å‘å‡º `compaction` äº‹ä»¶
6. é‡è¯•å½“å‰è¯·æ±‚

### 9.3 Docker éƒ¨ç½²

```yaml
# docker-compose.yml æ ¸å¿ƒé…ç½®
services:
  gateway:
    build: .
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - ./data:/root/.openclaw
      - ./workspace:/root/clawd
    ports:
      - "18789:18789"
```

### 9.4 Cloudflare Workers éƒ¨ç½² (Moltworker)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Cloudflare Worker                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   WebSocket ä»£ç† + è®¤è¯                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Cloudflare Sandbox (å®¹å™¨)              â”‚   â”‚
â”‚  â”‚   â””â”€ OpenClaw Gateway                   â”‚   â”‚
â”‚  â”‚   â””â”€ Node.js Runtime                    â”‚   â”‚
â”‚  â”‚   â””â”€ æµè§ˆå™¨è‡ªåŠ¨åŒ– (Browser Rendering)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   R2 Storage (å¯é€‰æŒä¹…åŒ–)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æˆæœ¬**: Workers Paid ($5/æœˆ) + API è°ƒç”¨è´¹

### 9.5 è¿œç¨‹è®¿é—®æ–¹æ¡ˆ

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|----------|
| **Tailscale Serve** | é«˜ | ä½ | ä¸ªäºº Tailnet |
| **Tailscale Funnel** | ä¸­ | ä½ | å…¬å¼€è®¿é—®ï¼ˆéœ€å¯†ç ï¼‰ |
| **SSH Tunnel** | é«˜ | ä¸­ | ä¸´æ—¶è®¿é—® |
| **Reverse Proxy** | ä¸­ | é«˜ | ç”Ÿäº§éƒ¨ç½² |

---

## 10. æŠ€æœ¯é€‰å‹å»ºè®®

### 10.1 å¦‚æœä½ è¦æ„å»ºç±»ä¼¼ç³»ç»Ÿ

**æ¨èé‡‡ç”¨çš„è®¾è®¡**:

| æ¨¡å— | OpenClaw æ–¹æ¡ˆ | å»ºè®® |
|------|---------------|------|
| **åè®®å±‚** | è‡ªå®šä¹‰ WS + TypeBox | âœ… é‡‡ç”¨ï¼Œç±»å‹å®‰å…¨ + è·¨å¹³å°ä»£ç ç”Ÿæˆ |
| **å•ä¸€æ§åˆ¶å¹³é¢** | Gateway æ¨¡å¼ | âœ… é‡‡ç”¨ï¼Œç®€åŒ–çŠ¶æ€ç®¡ç† |
| **æ¸ é“æŠ½è±¡** | æ’ä»¶åŒ– Channel | âœ… é‡‡ç”¨ï¼Œæ˜“æ‰©å±• |
| **å·¥å…·ç³»ç»Ÿ** | ç™½åå• + æ²™ç®± | âœ… é‡‡ç”¨ï¼Œå®‰å…¨ä¼˜å…ˆ |
| **ä¼šè¯æ¨¡å‹** | main + group åˆ†ç¦» | âœ… é‡‡ç”¨ï¼Œç¬¦åˆå®é™…åœºæ™¯ |

**å¯æ”¹è¿›çš„ç‚¹**:

| æ¨¡å— | å½“å‰é—®é¢˜ | æ”¹è¿›æ–¹å‘ |
|------|----------|----------|
| **æŒä¹…åŒ–** | JSON æ–‡ä»¶ | è€ƒè™‘ SQLite/åµŒå…¥å¼ DB |
| **æµ‹è¯•** | 70% è¦†ç›–ç‡ | æå‡è‡³ 85%+ |
| **æ–‡æ¡£** | Mintlify æ‰˜ç®¡ | æœ¬åœ°æ–‡æ¡£ + æœç´¢ |
| **ç›‘æ§** | è¾ƒå°‘ | é›†æˆ OpenTelemetry |

### 10.2 æ ¸å¿ƒæŠ€æœ¯é€‰å‹å‚è€ƒ

```typescript
// æ¨èæŠ€æœ¯æ ˆ
const recommendedStack = {
  runtime: "Node.js â‰¥22",      // ç¨³å®š + ESM åŸç”Ÿ
  language: "TypeScript 5.x",   // ä¸¥æ ¼æ¨¡å¼
  packageManager: "pnpm",       // é€Ÿåº¦ + ç£ç›˜æ•ˆç‡
  schema: "TypeBox",            // ç±»å‹å®‰å…¨ Schema
  websocket: "ws",              // è½»é‡çº§
  testing: "Vitest",            // å¿«é€Ÿ + å…¼å®¹ Jest
  formatting: "oxlint + oxfmt", // Rust å·¥å…·ï¼Œæå¿«
  
  // æ¶ˆæ¯å¹³å°
  whatsapp: "@whiskeysockets/baileys",  // æ— å®˜æ–¹ API æ—¶çš„é€‰æ‹©
  telegram: "grammy",                    // ä¼˜äº telegraf
  discord: "discord.js",                 // åŠŸèƒ½å®Œæ•´
  slack: "@slack/bolt",                  // å®˜æ–¹æ¨è
  
  // æµè§ˆå™¨æ§åˆ¶
  browser: "puppeteer-core",    // CDP åè®®
  
  // éƒ¨ç½²
  container: "Docker",
  orchestration: "docker-compose / fly.io / Cloudflare Workers",
};
```

---

## 11. æ€»ç»“

### 11.1 OpenClaw çš„æŠ€æœ¯äº®ç‚¹

1. **Gateway å•æ§åˆ¶å¹³é¢**: ç®€åŒ–äº†å¤šæ¸ é“ã€å¤šå®¢æˆ·ç«¯çš„çŠ¶æ€åŒæ­¥é—®é¢˜
2. **TypeBox åè®®ä¼˜å…ˆ**: ä¸€æ¬¡å®šä¹‰ï¼Œç”Ÿæˆ JSON Schema + Swift æ¨¡å‹ï¼Œå‡å°‘è·¨å¹³å°ä¸ä¸€è‡´
3. **æ²™ç®±å®‰å…¨æ¨¡å‹**: Docker éš”ç¦» + å·¥å…·ç™½åå•ï¼Œåœ¨å®ç”¨æ€§å’Œå®‰å…¨æ€§é—´å–å¾—å¹³è¡¡
4. **æ¸ é“æ’ä»¶åŒ–**: æ ¸å¿ƒæ¸ é“å†…ç½®ï¼Œæ‰©å±•æ¸ é“ç‹¬ç«‹åŠ è½½ï¼Œæ¶æ„æ¸…æ™°
5. **Skills å¹³å°**: ç±»ä¼¼ Claude Code çš„ SKILL.md çº¦å®šï¼Œç”Ÿæ€å¯æ‰©å±•

### 11.2 æ„å»ºç±»ä¼¼ç³»ç»Ÿçš„å…³é”®å†³ç­–ç‚¹

| å†³ç­– | é€‰é¡¹ | å»ºè®® |
|------|------|------|
| **å•ä½“ vs å¾®æœåŠ¡** | å•ä½“ Gateway | å¯¹äºä¸ªäººåŠ©æ‰‹åœºæ™¯ï¼Œå•ä½“æ›´åˆé€‚ |
| **æ¶ˆæ¯åè®®** | è‡ªå®šä¹‰ vs gRPC vs REST | è‡ªå®šä¹‰ WS åè®®ï¼Œçµæ´»åº¦é«˜ |
| **è®¤è¯æ–¹å¼** | Token vs OAuth vs Device | ä¸‰è€…ç»“åˆï¼Œè¦†ç›–ä¸åŒåœºæ™¯ |
| **AI æ¨¡å‹** | å•ä¸€ vs å¤šæ¨¡å‹ | å¤šæ¨¡å‹ + Fallbackï¼Œé¿å…ä¾›åº”å•†é”å®š |
| **æŒä¹…åŒ–** | æ–‡ä»¶ vs SQLite vs äº‘ | æœ¬åœ°æ–‡ä»¶è¶³å¤Ÿï¼Œè§„æ¨¡å¤§äº†è€ƒè™‘ SQLite |
| **éƒ¨ç½²æ¨¡å¼** | æœ¬åœ° vs äº‘ vs æ··åˆ | æ¨èæœ¬åœ° Gateway + å¯é€‰äº‘éš§é“ |

### 11.3 é£é™©æç¤º

- **æç¤ºæ³¨å…¥é˜²å¾¡ä»ä¸æˆç†Ÿ**: è¿™æ˜¯è¡Œä¸šçº§éš¾é¢˜ï¼Œé OpenClaw ç‰¹æœ‰
- **é«˜æƒé™å·¥å…·éœ€è°¨æ…**: shell è®¿é—® = root è®¿é—®ï¼Œå¿…é¡»æ²™ç®±åŒ–
- **æ¶ˆæ¯å¹³å° TOS é£é™©**: WhatsApp Web é€†å‘å¯èƒ½è¿åæœåŠ¡æ¡æ¬¾
- **æˆæœ¬æ§åˆ¶**: Claude API è°ƒç”¨è´¹ç”¨å¯èƒ½è¶…é¢„æœŸï¼ˆ$5-$150+/æœˆï¼‰

---

## é™„å½• A: å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶/ç›®å½• | ç”¨é€” |
|-----------|------|
| `src/gateway/index.ts` | Gateway å…¥å£ |
| `src/agent/loop.ts` | Agent å¾ªç¯æ ¸å¿ƒ |
| `src/channels/index.ts` | æ¸ é“æ³¨å†Œä¸ç®¡ç† |
| `src/tools/index.ts` | å·¥å…·æ³¨å†Œè¡¨ |
| `src/config/schema.ts` | TypeBox é…ç½® Schema |
| `scripts/protocol-gen.ts` | åè®®ä»£ç ç”Ÿæˆ |
| `apps/macos/Sources/MoltbotProtocol/` | Swift è‡ªåŠ¨ç”Ÿæˆæ¨¡å‹ |
| `~/.openclaw/openclaw.json` | è¿è¡Œæ—¶é…ç½® |
| `~/.openclaw/credentials/` | æ¸ é“å‡­æ®å­˜å‚¨ |
| `~/clawd/` | é»˜è®¤å·¥ä½œåŒº |

## é™„å½• B: å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘
pnpm install                    # å®‰è£…ä¾èµ–
pnpm build                      # æ„å»º
pnpm gateway:watch              # å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
pnpm test                       # è¿è¡Œæµ‹è¯•
pnpm lint                       # ä»£ç æ£€æŸ¥
pnpm protocol:gen               # é‡æ–°ç”Ÿæˆåè®®

# è¿ç»´
openclaw doctor                 # é…ç½®æ£€æŸ¥
openclaw status --all           # çŠ¶æ€æŠ¥å‘Š
openclaw logs -f                # å®æ—¶æ—¥å¿—
openclaw dashboard              # æ‰“å¼€ Control UI
openclaw gateway --verbose      # å‰å°è¿è¡Œ
```

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-01-31*  
*æ•°æ®æ¥æº: GitHub ä»“åº“ã€å®˜æ–¹æ–‡æ¡£ã€æŠ€æœ¯åšå®¢ã€å®‰å…¨ç ”ç©¶æŠ¥å‘Š*
