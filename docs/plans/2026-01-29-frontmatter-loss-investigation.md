# Frontmatter 流程统一与字段分离重构

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 统一所有文档处理流程使用 Instructor 结构化输出；分离 LLM 生成字段（description/tags）和程序生成字段（title/source/markitai_processed）

**Architecture:**
- 移除独立的 `generate_frontmatter()` 流程
- 分页场景第一批次使用 `_enhance_with_frontmatter_first_batch()` 生成 frontmatter
- 后续批次仅做内容清理
- `title` 由程序从内容提取，`source`/`markitai_processed` 由程序填充

**Tech Stack:** Python, Pydantic, Instructor, LiteLLM

---

## 当前问题分析

### 流程差异

| 场景 | 当前流程 | frontmatter 来源 |
|------|----------|-----------------|
| PDF/XLSX/PPT (≤10页) | `_enhance_with_frontmatter()` | Instructor 结构化输出 |
| PPTX (>10页) | `_enhance_document_batched_simple()` + `generate_frontmatter()` | 独立 LLM 调用（非结构化） |

### 根本原因

1. `generate_frontmatter()` 不使用 Instructor，直接返回 YAML 字符串
2. 系统 prompt 中 `{source}` 和 `{language}` 占位符未被替换
3. LLM 返回询问性响应而非 YAML

---

## 重构设计

### 字段分类

| 字段 | 来源 | 说明 |
|------|------|------|
| `title` | 程序提取 | 从 markdown 第一个 H1/H2 提取 |
| `source` | 程序填充 | 源文件名 |
| `markitai_processed` | 程序填充 | ISO 8601 时间戳 |
| `description` | LLM 生成 | 100 字内摘要 |
| `tags` | LLM 生成 | 3-5 个标签 |

### 新流程设计

```
┌──────────────────────────────────────────────────────────────────┐
│                    统一的 Frontmatter 生成流程                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 【单批处理】(≤10页)                                              │
│   └─ _enhance_with_frontmatter()                                │
│       ├─ Instructor: EnhancedDocumentResult                     │
│       │   └─ frontmatter: { description, tags }  ← LLM         │
│       └─ 程序插入: title, source, markitai_processed            │
│                                                                  │
│ 【多批处理】(>10页)                                              │
│   ├─ Batch 1: _enhance_with_frontmatter_first_batch()          │
│   │   ├─ Instructor: EnhancedDocumentResult                     │
│   │   │   └─ frontmatter: { description, tags }  ← LLM         │
│   │   └─ 返回: (cleaned_batch1, frontmatter)                   │
│   │                                                              │
│   ├─ Batch 2..N: enhance_document_with_vision()                │
│   │   └─ 仅清理，无 frontmatter                                 │
│   │                                                              │
│   └─ 合并结果 + 程序插入: title, source, markitai_processed     │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## Tasks

### Task 1: 修改 Frontmatter 模型 - 移除 title 字段

**Files:**
- Modify: `packages/markitai/src/markitai/llm/types.py`

**Step 1: 更新 Frontmatter 模型**

移除 `title` 字段，因为它将由程序提取。

```python
class Frontmatter(BaseModel):
    """Pydantic model for document frontmatter.

    Note: title, source, and markitai_processed are NOT included here
    as they are generated programmatically, not by LLM.
    """

    description: str = Field(description="Brief summary of the document (100 chars max)")
    tags: list[str] = Field(description="Related tags (3-5 items)")

    @field_validator("description", mode="before")
    @classmethod
    def clean_control_chars(cls, v: str | None) -> str | None:
        """Remove control characters that can cause JSON parsing errors."""
        if v is None:
            return None
        return clean_control_characters(v)

    @field_validator("tags", mode="before")
    @classmethod
    def clean_tags_control_chars(cls, v: list[str] | None) -> list[str] | None:
        """Remove control characters from tags."""
        if v is None:
            return None
        return [clean_control_characters(tag) for tag in v]
```

**Step 2: Run tests**

```bash
uv run pytest tests/unit/llm/test_types.py -v
```

**Step 3: Commit**

```bash
git add packages/markitai/src/markitai/llm/types.py
git commit -m "$(cat <<'EOF'
refactor(llm): remove title from Frontmatter model

Title is now extracted programmatically from content, not generated by LLM.
Only description and tags are LLM-generated fields.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 2: 添加程序化 title 提取函数

**Files:**
- Create: `packages/markitai/src/markitai/utils/frontmatter.py`
- Create: `tests/unit/utils/test_frontmatter.py`

**Step 1: 创建 frontmatter 工具模块**

```python
# packages/markitai/src/markitai/utils/frontmatter.py
"""Programmatic frontmatter field generation utilities."""

from __future__ import annotations

import re
from datetime import datetime
from typing import Any

import yaml


def extract_title_from_content(content: str, fallback: str = "") -> str:
    """Extract title from markdown content.

    Priority:
    1. First H1 heading (# Title)
    2. First H2 heading (## Title)
    3. First non-empty line
    4. Fallback value

    Args:
        content: Markdown content
        fallback: Fallback title if extraction fails

    Returns:
        Extracted title string
    """
    if not content:
        return fallback

    # Try H1 first
    h1_match = re.search(r"^#\s+(.+?)(?:\n|$)", content, re.MULTILINE)
    if h1_match:
        return h1_match.group(1).strip()

    # Try H2
    h2_match = re.search(r"^##\s+(.+?)(?:\n|$)", content, re.MULTILINE)
    if h2_match:
        return h2_match.group(1).strip()

    # Try first non-empty line (skip frontmatter and comments)
    lines = content.split("\n")
    in_frontmatter = False
    for line in lines:
        line = line.strip()
        if line == "---":
            in_frontmatter = not in_frontmatter
            continue
        if in_frontmatter:
            continue
        if line.startswith("<!--") or not line:
            continue
        # Remove markdown formatting
        title = re.sub(r"^[#*_`]+\s*", "", line)
        title = re.sub(r"[*_`]+$", "", title)
        if title:
            return title[:100]  # Limit length

    return fallback


def build_frontmatter_dict(
    *,
    source: str,
    description: str = "",
    tags: list[str] | None = None,
    title: str | None = None,
    content: str = "",
) -> dict[str, Any]:
    """Build complete frontmatter dict with programmatic fields.

    Args:
        source: Source filename (required)
        description: LLM-generated description
        tags: LLM-generated tags
        title: Optional explicit title, or extracted from content
        content: Content for title extraction if title not provided

    Returns:
        Complete frontmatter dict with all fields
    """
    # Extract title if not provided
    if title is None:
        # Use source filename without extension as fallback
        fallback = re.sub(r"\.[^.]+$", "", source)
        title = extract_title_from_content(content, fallback)

    # Build dict with consistent field order
    frontmatter: dict[str, Any] = {
        "title": title,
        "source": source,
        "description": description,
    }

    if tags:
        frontmatter["tags"] = tags

    # Add timestamp
    frontmatter["markitai_processed"] = datetime.now().astimezone().isoformat()

    return frontmatter


def frontmatter_to_yaml(frontmatter: dict[str, Any]) -> str:
    """Convert frontmatter dict to YAML string.

    Args:
        frontmatter: Frontmatter dict

    Returns:
        YAML string (without --- markers)
    """
    return yaml.dump(
        frontmatter,
        allow_unicode=True,
        default_flow_style=False,
        sort_keys=False,
    ).strip()
```

**Step 2: 创建测试文件**

```python
# tests/unit/utils/test_frontmatter.py
"""Tests for frontmatter utilities."""

import pytest
from markitai.utils.frontmatter import (
    extract_title_from_content,
    build_frontmatter_dict,
    frontmatter_to_yaml,
)


class TestExtractTitleFromContent:
    def test_extract_h1(self):
        content = "# My Document Title\n\nSome content here."
        assert extract_title_from_content(content) == "My Document Title"

    def test_extract_h2_when_no_h1(self):
        content = "## Secondary Title\n\nContent."
        assert extract_title_from_content(content) == "Secondary Title"

    def test_prefer_h1_over_h2(self):
        content = "## Intro\n\n# Main Title\n\nContent."
        # H1 appears after H2, but H1 should still be found
        assert extract_title_from_content(content) == "Main Title"

    def test_skip_frontmatter(self):
        content = "---\ntitle: Ignored\n---\n\n# Actual Title"
        assert extract_title_from_content(content) == "Actual Title"

    def test_skip_comments(self):
        content = "<!-- comment -->\n# Real Title"
        assert extract_title_from_content(content) == "Real Title"

    def test_fallback_to_first_line(self):
        content = "Just some text without heading"
        assert extract_title_from_content(content) == "Just some text without heading"

    def test_empty_content_uses_fallback(self):
        assert extract_title_from_content("", "Fallback") == "Fallback"

    def test_limit_length(self):
        long_line = "A" * 200
        result = extract_title_from_content(long_line)
        assert len(result) <= 100


class TestBuildFrontmatterDict:
    def test_basic_build(self):
        result = build_frontmatter_dict(
            source="test.pdf",
            description="A test document",
            tags=["test", "document"],
            content="# Test Title\n\nContent",
        )
        assert result["title"] == "Test Title"
        assert result["source"] == "test.pdf"
        assert result["description"] == "A test document"
        assert result["tags"] == ["test", "document"]
        assert "markitai_processed" in result

    def test_explicit_title(self):
        result = build_frontmatter_dict(
            source="test.pdf",
            description="",
            title="Explicit Title",
        )
        assert result["title"] == "Explicit Title"

    def test_fallback_to_filename(self):
        result = build_frontmatter_dict(
            source="my-document.pdf",
            description="",
            content="",  # No content for extraction
        )
        assert result["title"] == "my-document"


class TestFrontmatterToYaml:
    def test_yaml_output(self):
        frontmatter = {
            "title": "Test",
            "source": "test.pdf",
            "description": "Description",
            "tags": ["a", "b"],
        }
        yaml_str = frontmatter_to_yaml(frontmatter)
        assert "title: Test" in yaml_str
        assert "source: test.pdf" in yaml_str
```

**Step 3: Run tests**

```bash
uv run pytest tests/unit/utils/test_frontmatter.py -v
```

**Step 4: Commit**

```bash
git add packages/markitai/src/markitai/utils/frontmatter.py tests/unit/utils/test_frontmatter.py
git commit -m "$(cat <<'EOF'
feat(utils): add frontmatter utilities for programmatic field generation

- extract_title_from_content(): Extract title from H1/H2/first line
- build_frontmatter_dict(): Build complete frontmatter with all fields
- frontmatter_to_yaml(): Convert dict to YAML string

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 3: 更新 Prompt - 移除 title 指令

**Files:**
- Modify: `packages/markitai/src/markitai/prompts/document_enhance_complete_system.md`
- Modify: `packages/markitai/src/markitai/prompts/document_process_system.md`
- Modify: `packages/markitai/src/markitai/prompts/url_enhance_system.md`
- Delete: `packages/markitai/src/markitai/prompts/frontmatter_system.md`
- Delete: `packages/markitai/src/markitai/prompts/frontmatter_user.md`

**Step 1: 更新 document_enhance_complete_system.md**

将"任务 2: 元数据生成"部分修改为只生成 description 和 tags：

```markdown
## 任务 2: 元数据生成

生成以下字段（**注意：title 不需要生成，由程序提取**）：

- description: 全文摘要（100字以内，简洁概括核心内容）
- tags: 相关标签数组（3-5个，用于分类和检索）

**输出语言必须与源文档保持一致**（英文文档→英文元数据，中文文档→中文元数据）
```

**Step 2: 同样更新 document_process_system.md 和 url_enhance_system.md**

**Step 3: 删除独立的 frontmatter prompt 文件**

```bash
rm packages/markitai/src/markitai/prompts/frontmatter_system.md
rm packages/markitai/src/markitai/prompts/frontmatter_user.md
```

**Step 4: Commit**

```bash
git add -A packages/markitai/src/markitai/prompts/
git commit -m "$(cat <<'EOF'
refactor(prompts): remove title from LLM metadata generation

- Updated all prompts to only request description and tags
- Removed standalone frontmatter_system.md and frontmatter_user.md
- Title is now extracted programmatically

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 4: 重构 enhance_document_complete() - 统一分页流程

**Files:**
- Modify: `packages/markitai/src/markitai/llm/document.py`

**Step 1: 修改 enhance_document_complete() 分页处理逻辑**

关键变更：
1. 移除并行的 `generate_frontmatter()` 调用
2. 第一批次使用 `_enhance_with_frontmatter()` 生成 frontmatter
3. 后续批次仅使用 `enhance_document_with_vision()` 清理

```python
async def enhance_document_complete(
    self,
    extracted_text: str,
    page_images: list[Path],
    source: str = "",
    max_pages_per_batch: int = 10,
) -> tuple[str, str]:
    """Enhance document with vision and generate frontmatter.

    For multi-batch processing, only the first batch generates frontmatter.

    Args:
        extracted_text: Extracted text from document
        page_images: Page images for visual reference
        source: Source filename
        max_pages_per_batch: Max pages per batch

    Returns:
        Tuple of (cleaned_markdown, frontmatter_yaml)
    """
    if len(page_images) <= max_pages_per_batch:
        # Single batch: use combined call
        try:
            return await self._enhance_with_frontmatter(
                extracted_text, page_images, source
            )
        except Exception as e:
            logger.warning(
                f"[{source}] Combined call failed: {format_error_message(e)}, "
                "falling back to separate calls"
            )
            # Fallback: vision cleaning only + programmatic frontmatter
            cleaned = await self.enhance_document_with_vision(
                extracted_text, page_images, context=source
            )
            frontmatter = self._build_fallback_frontmatter(source, cleaned)
            return cleaned, frontmatter

    # Multi-batch processing
    logger.info(
        f"[{source}] Processing {len(page_images)} pages in batches of "
        f"{max_pages_per_batch} (first batch generates frontmatter)"
    )

    # Split pages into batches
    batches = self._split_into_batches(page_images, max_pages_per_batch)
    text_batches = self._split_text_by_pages(extracted_text, len(batches))

    # Process first batch WITH frontmatter
    first_batch_images = batches[0]
    first_batch_text = text_batches[0]

    try:
        cleaned_first, frontmatter = await self._enhance_with_frontmatter(
            first_batch_text, first_batch_images, source
        )
    except Exception as e:
        logger.warning(
            f"[{source}] First batch combined call failed: {format_error_message(e)}"
        )
        cleaned_first = await self.enhance_document_with_vision(
            first_batch_text, first_batch_images, context=source
        )
        frontmatter = self._build_fallback_frontmatter(source, extracted_text)

    # Process remaining batches WITHOUT frontmatter (parallel)
    if len(batches) > 1:
        remaining_tasks = [
            self.enhance_document_with_vision(
                text_batches[i], batches[i], context=source
            )
            for i in range(1, len(batches))
        ]
        remaining_results = await asyncio.gather(
            *remaining_tasks, return_exceptions=True
        )

        # Combine results
        cleaned_parts = [cleaned_first]
        for i, result in enumerate(remaining_results):
            if isinstance(result, BaseException):
                logger.warning(
                    f"[{source}] Batch {i+2} failed: {format_error_message(result)}, "
                    "using original text"
                )
                cleaned_parts.append(text_batches[i + 1])
            else:
                cleaned_parts.append(result)

        cleaned = "\n\n".join(cleaned_parts)
    else:
        cleaned = cleaned_first

    return cleaned, frontmatter


def _build_fallback_frontmatter(self, source: str, content: str) -> str:
    """Build fallback frontmatter when LLM fails.

    Uses programmatic extraction for all fields.
    """
    from markitai.utils.frontmatter import build_frontmatter_dict, frontmatter_to_yaml

    frontmatter_dict = build_frontmatter_dict(
        source=source,
        description="",
        tags=[],
        content=content,
    )
    return frontmatter_to_yaml(frontmatter_dict)
```

**Step 2: 更新 _enhance_with_frontmatter() 构建 frontmatter 的方式**

```python
# 在 _enhance_with_frontmatter() 中，修改构建 frontmatter 的部分
# 从：
frontmatter_dict = {
    "title": response.frontmatter.title,
    "description": response.frontmatter.description,
    "tags": response.frontmatter.tags,
    "source": source,
}

# 改为：
from markitai.utils.frontmatter import build_frontmatter_dict, frontmatter_to_yaml

frontmatter_dict = build_frontmatter_dict(
    source=source,
    description=response.frontmatter.description,
    tags=response.frontmatter.tags,
    content=cleaned_markdown,  # For title extraction
)
frontmatter_yaml = frontmatter_to_yaml(frontmatter_dict)
```

**Step 3: Run tests**

```bash
uv run pytest tests/unit/llm/ tests/integration/ -v
```

**Step 4: Commit**

```bash
git add packages/markitai/src/markitai/llm/document.py
git commit -m "$(cat <<'EOF'
refactor(llm): unify multi-batch processing with Instructor

- First batch now uses _enhance_with_frontmatter() for structured output
- Remaining batches only do vision cleaning (no frontmatter)
- Removed parallel generate_frontmatter() call
- Use programmatic title extraction instead of LLM

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 5: 移除 generate_frontmatter() 函数

**Files:**
- Modify: `packages/markitai/src/markitai/llm/document.py`

**Step 1: 删除 generate_frontmatter() 函数**

移除整个函数（约 lines 204-271），因为不再需要独立的 frontmatter 生成。

**Step 2: 更新 process_document() 中的降级逻辑**

```python
async def process_document(
    self,
    markdown: str,
    source: str = "",
) -> tuple[str, str]:
    """Process document with LLM cleaning and frontmatter generation.

    Uses Instructor for structured output.
    """
    # Try combined processing
    try:
        result = await self._process_document_combined(markdown, source)

        from markitai.utils.frontmatter import build_frontmatter_dict, frontmatter_to_yaml

        frontmatter_dict = build_frontmatter_dict(
            source=source,
            description=result.frontmatter.description,
            tags=result.frontmatter.tags,
            content=result.cleaned_markdown,
        )
        return result.cleaned_markdown, frontmatter_to_yaml(frontmatter_dict)

    except Exception as e:
        logger.warning(
            f"[{source}] Combined processing failed: {format_error_message(e)}, "
            "falling back to cleaning only"
        )
        # Fallback: just clean, use empty frontmatter fields
        try:
            cleaned = await self.clean_markdown(markdown, context=source)
        except Exception:
            cleaned = markdown

        frontmatter = self._build_fallback_frontmatter(source, cleaned)
        return cleaned, frontmatter
```

**Step 3: Run full test suite**

```bash
uv run pytest -v
```

**Step 4: Commit**

```bash
git add packages/markitai/src/markitai/llm/document.py
git commit -m "$(cat <<'EOF'
refactor(llm): remove standalone generate_frontmatter()

All frontmatter generation now goes through Instructor structured output.
Fallback uses programmatic extraction only.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 6: 更新 format_llm_output() - 简化 frontmatter 处理

**Files:**
- Modify: `packages/markitai/src/markitai/llm/document.py`

**Step 1: 简化 format_llm_output()**

由于 frontmatter 现在总是由程序构建的 dict，不再需要复杂的 YAML 解析和修复逻辑。

```python
def format_llm_output(
    self,
    markdown: str,
    frontmatter: str,
    source: str = "",
) -> str:
    """Format LLM output with frontmatter.

    Since frontmatter is now always generated programmatically with proper
    structure, this function only needs to combine them.

    Args:
        markdown: Cleaned markdown content
        frontmatter: YAML frontmatter string (without --- markers)
        source: Source filename (for fallback)

    Returns:
        Complete markdown with frontmatter
    """
    # Remove any accidental --- markers from frontmatter
    frontmatter = frontmatter.strip()
    if frontmatter.startswith("---"):
        frontmatter = frontmatter[3:].strip()
    if frontmatter.endswith("---"):
        frontmatter = frontmatter[:-3].strip()

    # Clean markdown content
    markdown = self._remove_uncommented_screenshots(markdown)

    from markitai.utils.text import (
        clean_ppt_headers_footers,
        clean_residual_placeholders,
        fix_broken_markdown_links,
        normalize_markdown_whitespace,
    )

    markdown = fix_broken_markdown_links(markdown)
    markdown = clean_ppt_headers_footers(markdown)
    markdown = clean_residual_placeholders(markdown)
    markdown = normalize_markdown_whitespace(markdown)

    return f"---\n{frontmatter}\n---\n\n{markdown}"
```

**Step 2: Run tests**

```bash
uv run pytest tests/unit/llm/test_document.py -v
```

**Step 3: Commit**

```bash
git add packages/markitai/src/markitai/llm/document.py
git commit -m "$(cat <<'EOF'
refactor(llm): simplify format_llm_output()

Removed complex YAML parsing and fallback logic since frontmatter
is now always generated with proper structure.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 7: 端到端验证

**Step 1: 清除缓存并重新处理 PPTX**

```bash
uv run markitai packages/markitai/tests/fixtures/Free_Test_Data_500KB_PPTX.pptx \
  --preset rich --no-cache -o output --verbose
```

**Step 2: 验证输出**

```bash
head -20 output/Free_Test_Data_500KB_PPTX.pptx.llm.md
```

预期输出：
```yaml
---
title: FREE TEST DATA
source: Free_Test_Data_500KB_PPTX.pptx
description: A presentation containing Lorem ipsum placeholder text across multiple slides with tables and images.
tags:
- presentation
- test data
- lorem ipsum
markitai_processed: '2026-01-29T...'
---
```

**Step 3: 验证其他文件格式**

```bash
# PDF
uv run markitai packages/markitai/tests/fixtures/file-example_PDF_500_kB.pdf \
  --preset rich --no-cache -o output --verbose
head -15 output/file-example_PDF_500_kB.pdf.llm.md

# XLSX
uv run markitai packages/markitai/tests/fixtures/file_example_XLSX_100.xlsx \
  --preset rich --no-cache -o output --verbose
head -15 output/file_example_XLSX_100.xlsx.llm.md
```

**Step 4: Commit integration test results**

```bash
git add -A
git commit -m "$(cat <<'EOF'
test: verify unified frontmatter generation across file types

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Summary

| 变更 | 说明 |
|------|------|
| Frontmatter 模型 | 移除 `title`，只保留 `description` 和 `tags` |
| 程序化字段 | `title` 从内容提取，`source`/`markitai_processed` 程序填充 |
| 分页处理 | 第一批次用 Instructor 生成 frontmatter，后续批次仅清理 |
| 移除函数 | 删除 `generate_frontmatter()` |
| Prompt 精简 | 删除独立 frontmatter prompt，更新其他 prompt 移除 title 指令 |

## 文件变更列表

```
Modified:
  packages/markitai/src/markitai/llm/types.py
  packages/markitai/src/markitai/llm/document.py
  packages/markitai/src/markitai/prompts/document_enhance_complete_system.md
  packages/markitai/src/markitai/prompts/document_process_system.md
  packages/markitai/src/markitai/prompts/url_enhance_system.md

Created:
  packages/markitai/src/markitai/utils/frontmatter.py
  tests/unit/utils/test_frontmatter.py

Deleted:
  packages/markitai/src/markitai/prompts/frontmatter_system.md
  packages/markitai/src/markitai/prompts/frontmatter_user.md
```
