#!/bin/sh
# Markitai Setup Script - Unified installer with i18n support
# Supports bash/zsh/dash and other POSIX-compatible shells
# Auto-detects: language (en/zh), mode (user/dev)
#
# Usage:
#   curl -fsSL https://markitai.ynewtime.com/setup.sh | sh    # User install
#   ./scripts/setup.sh                                         # Dev setup (in repo)

set -e

# ============================================================
# Internationalization (i18n) System
# ============================================================

# Detect language from environment
# Returns: "zh" for Chinese, "en" for English (default)
detect_lang() {
    _lang_env="${LANG:-}${LC_ALL:-}${LC_MESSAGES:-}"
    case "$_lang_env" in
        zh_CN*|zh_TW*|zh_HK*|zh_SG*|zh.*)
            echo "zh"
            ;;
        *)
            echo "en"
            ;;
    esac
}

LANG_CODE=$(detect_lang)

# Internationalization function
# Usage: i18n "key"
# Returns localized string for the given key
i18n() {
    _key="$1"

    if [ "$LANG_CODE" = "zh" ]; then
        case "$_key" in
            # Intro/Outro
            welcome)                    echo "欢迎使用 Markitai 安装程序!" ;;
            setup_complete)             echo "安装完成!" ;;
            dev_setup_complete)         echo "开发环境设置完成!" ;;

            # Sections
            section_prerequisites)      echo "前置条件" ;;
            section_core)               echo "核心组件" ;;
            section_optional)           echo "可选组件" ;;
            section_dev_env)            echo "开发环境" ;;
            section_llm_cli)            echo "LLM CLI 工具" ;;
            section_summary)            echo "安装摘要" ;;

            # Status
            installed)                  echo "已安装" ;;
            installing)                 echo "正在安装" ;;
            skipped)                    echo "已跳过" ;;
            failed)                     echo "失败" ;;
            success)                    echo "成功" ;;
            already_installed)          echo "已经安装" ;;

            # Components
            uv)                         echo "uv 包管理器" ;;
            python)                     echo "Python" ;;
            markitai)                   echo "markitai" ;;
            playwright)                 echo "Playwright 浏览器" ;;
            libreoffice)                echo "LibreOffice" ;;
            ffmpeg)                     echo "FFmpeg" ;;
            claude_cli)                 echo "Claude Code CLI" ;;
            copilot_cli)                echo "Copilot CLI" ;;
            precommit)                  echo "pre-commit hooks" ;;
            python_deps)                echo "Python 依赖" ;;

            # Confirmations
            confirm_playwright)         echo "安装 Playwright 浏览器? (用于 JS 渲染页面)" ;;
            confirm_libreoffice)        echo "安装 LibreOffice? (用于 Office 文档转换)" ;;
            confirm_ffmpeg)             echo "安装 FFmpeg? (用于音视频处理)" ;;
            confirm_claude_cli)         echo "安装 Claude Code CLI? (使用 Claude 订阅)" ;;
            confirm_copilot_cli)        echo "安装 Copilot CLI? (使用 GitHub Copilot 订阅)" ;;
            confirm_uv)                 echo "安装 uv 包管理器?" ;;
            confirm_continue_as_root)   echo "以 root 身份继续?" ;;

            # Info messages
            info_libreoffice_purpose)   echo "LibreOffice 用于将 Office 文档 (docx/xlsx/pptx) 转换为 Markdown" ;;
            info_ffmpeg_purpose)        echo "FFmpeg 用于处理音频和视频文件" ;;
            info_playwright_purpose)    echo "Playwright 用于获取 JavaScript 渲染的网页内容" ;;
            info_project_dir)           echo "项目目录" ;;
            info_docs)                  echo "文档" ;;
            info_issues)                echo "问题反馈" ;;
            info_syncing_deps)          echo "正在同步依赖..." ;;
            info_deps_synced)           echo "依赖同步完成" ;;
            info_precommit_installed)   echo "pre-commit hooks 已安装" ;;

            # Error messages
            error_uv_required)          echo "需要安装 uv 包管理器" ;;
            error_python_required)      echo "需要安装 Python 3.11+" ;;
            error_setup_failed)         echo "安装失败" ;;

            # Warnings
            warn_root)                  echo "警告: 以 root 身份运行" ;;
            warn_root_risk)             echo "以 root 运行安装脚本存在安全风险" ;;

            # Getting started
            getting_started)            echo "开始使用" ;;
            quick_start)                echo "快速开始" ;;
            activate_venv)              echo "激活虚拟环境" ;;
            run_tests)                  echo "运行测试" ;;
            run_cli)                    echo "运行 CLI" ;;
            interactive_mode)           echo "交互模式" ;;
            convert_file)               echo "转换文件" ;;
            show_help)                  echo "显示帮助" ;;

            # Summary
            summary_installed)          echo "已安装" ;;
            summary_skipped)            echo "已跳过" ;;
            summary_failed)             echo "安装失败" ;;

            # Default fallback
            *)                          echo "$_key" ;;
        esac
    else
        # English (default)
        case "$_key" in
            # Intro/Outro
            welcome)                    echo "Welcome to Markitai Setup!" ;;
            setup_complete)             echo "Setup complete!" ;;
            dev_setup_complete)         echo "Development environment ready!" ;;

            # Sections
            section_prerequisites)      echo "Prerequisites" ;;
            section_core)               echo "Core Components" ;;
            section_optional)           echo "Optional Components" ;;
            section_dev_env)            echo "Development Environment" ;;
            section_llm_cli)            echo "LLM CLI Tools" ;;
            section_summary)            echo "Installation Summary" ;;

            # Status
            installed)                  echo "installed" ;;
            installing)                 echo "installing" ;;
            skipped)                    echo "skipped" ;;
            failed)                     echo "failed" ;;
            success)                    echo "success" ;;
            already_installed)          echo "already installed" ;;

            # Components
            uv)                         echo "uv package manager" ;;
            python)                     echo "Python" ;;
            markitai)                   echo "markitai" ;;
            playwright)                 echo "Playwright browser" ;;
            libreoffice)                echo "LibreOffice" ;;
            ffmpeg)                     echo "FFmpeg" ;;
            claude_cli)                 echo "Claude Code CLI" ;;
            copilot_cli)                echo "Copilot CLI" ;;
            precommit)                  echo "pre-commit hooks" ;;
            python_deps)                echo "Python dependencies" ;;

            # Confirmations
            confirm_playwright)         echo "Install Playwright browser? (for JS-rendered pages)" ;;
            confirm_libreoffice)        echo "Install LibreOffice? (for Office document conversion)" ;;
            confirm_ffmpeg)             echo "Install FFmpeg? (for audio/video processing)" ;;
            confirm_claude_cli)         echo "Install Claude Code CLI? (use your Claude subscription)" ;;
            confirm_copilot_cli)        echo "Install Copilot CLI? (use your GitHub Copilot subscription)" ;;
            confirm_uv)                 echo "Install uv package manager?" ;;
            confirm_continue_as_root)   echo "Continue as root?" ;;

            # Info messages
            info_libreoffice_purpose)   echo "LibreOffice converts Office documents (docx/xlsx/pptx) to Markdown" ;;
            info_ffmpeg_purpose)        echo "FFmpeg processes audio and video files" ;;
            info_playwright_purpose)    echo "Playwright fetches JavaScript-rendered web pages" ;;
            info_project_dir)           echo "Project directory" ;;
            info_docs)                  echo "Documentation" ;;
            info_issues)                echo "Issues" ;;
            info_syncing_deps)          echo "Syncing dependencies..." ;;
            info_deps_synced)           echo "Dependencies synced" ;;
            info_precommit_installed)   echo "pre-commit hooks installed" ;;

            # Error messages
            error_uv_required)          echo "uv package manager is required" ;;
            error_python_required)      echo "Python 3.11+ is required" ;;
            error_setup_failed)         echo "Setup failed" ;;

            # Warnings
            warn_root)                  echo "Warning: Running as root" ;;
            warn_root_risk)             echo "Running setup scripts as root carries security risks" ;;

            # Getting started
            getting_started)            echo "Getting Started" ;;
            quick_start)                echo "Quick Start" ;;
            activate_venv)              echo "Activate virtual environment" ;;
            run_tests)                  echo "Run tests" ;;
            run_cli)                    echo "Run CLI" ;;
            interactive_mode)           echo "Interactive mode" ;;
            convert_file)               echo "Convert a file" ;;
            show_help)                  echo "Show help" ;;

            # Summary
            summary_installed)          echo "Installed" ;;
            summary_skipped)            echo "Skipped" ;;
            summary_failed)             echo "Failed" ;;

            # Default fallback
            *)                          echo "$_key" ;;
        esac
    fi
}

# ============================================================
# Color Definitions
# ============================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
GRAY='\033[0;90m'
NC='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

# ============================================================
# Clack-style Visual Components
# Inspired by @clack/prompts - beautiful CLI with guide lines
# ============================================================

# Guide line characters
S_BAR="│"
S_BAR_H="─"
S_CORNER_TOP_RIGHT="┐"
S_CORNER_BOTTOM_RIGHT="┘"
S_CONNECT_LEFT="├"
S_STEP_ACTIVE="◆"
S_STEP_SUBMIT="◇"
S_RADIO_ACTIVE="●"
S_RADIO_INACTIVE="○"
S_CHECKBOX_ACTIVE="◼"
S_CHECKBOX_INACTIVE="◻"

# Session intro - start of CLI flow
# Usage: clack_intro "Title"
clack_intro() {
    printf "\n"
    printf "${GRAY}┌${NC}  ${BOLD}%s${NC}\n" "$1"
    printf "${GRAY}│${NC}\n"
}

# Session outro - end of CLI flow
# Usage: clack_outro "Message"
clack_outro() {
    printf "${GRAY}│${NC}\n"
    printf "${GRAY}└${NC}  ${GREEN}%s${NC}\n" "$1"
    printf "\n"
}

# Section header with active marker
# Usage: clack_section "Section title"
clack_section() {
    printf "${GRAY}│${NC}\n"
    printf "${MAGENTA}◆${NC}  ${BOLD}%s${NC}\n" "$1"
}

# Log with guide line - success
# Usage: clack_success "Message"
clack_success() {
    printf "${GRAY}│${NC}  ${GREEN}✓${NC} %s\n" "$1"
}

# Log with guide line - error
# Usage: clack_error "Message"
clack_error() {
    printf "${GRAY}│${NC}  ${RED}✗${NC} %s\n" "$1"
}

# Log with guide line - warning
# Usage: clack_warn "Message"
clack_warn() {
    printf "${GRAY}│${NC}  ${YELLOW}!${NC} %s\n" "$1"
}

# Log with guide line - info
# Usage: clack_info "Message"
clack_info() {
    printf "${GRAY}│${NC}  ${CYAN}→${NC} %s\n" "$1"
}

# Log with guide line - skipped
# Usage: clack_skip "Message"
clack_skip() {
    printf "${GRAY}│${NC}  ${GRAY}○${NC} ${GRAY}%s${NC}\n" "$1"
}

# Log with guide line - plain text
# Usage: clack_log "Message"
clack_log() {
    printf "${GRAY}│${NC}  %b\n" "$1"
}

# Spinner with guide line
# Usage: clack_spinner "message" command args...
# Shows spinner while command runs, then shows result
clack_spinner() {
    _cs_message="$1"
    shift

    # Spinner frames (ASCII compatible)
    _cs_pid=""

    # Start spinner in background
    (
        while true; do
            for _cs_frame in '|' '/' '-' '\'; do
                printf "\r${GRAY}│${NC}  ${CYAN}%s${NC} %s" "$_cs_frame" "$_cs_message"
                sleep 0.1 2>/dev/null || sleep 1
            done
        done
    ) &
    _cs_pid=$!

    # Run the actual command
    "$@" >/dev/null 2>&1
    _cs_status=$?

    # Stop spinner
    kill "$_cs_pid" 2>/dev/null
    wait "$_cs_pid" 2>/dev/null

    # Clear spinner line
    printf "\r\033[K"

    return $_cs_status
}

# Confirm prompt with guide line
# Usage: clack_confirm "Question?" "y|n"
# Returns: 0 for yes, 1 for no
clack_confirm() {
    _cc_prompt="$1"
    _cc_default="$2"

    if [ "$_cc_default" = "y" ]; then
        _cc_hint="${BOLD}Y${NC}${GRAY}/n${NC}"
    else
        _cc_hint="${GRAY}y/${NC}${BOLD}N${NC}"
    fi

    printf "${GRAY}│${NC}\n"
    printf "${CYAN}◇${NC}  %s ${GRAY}[%b]${NC} " "$_cc_prompt" "$_cc_hint"

    # Read from /dev/tty for piped execution support
    if [ -t 0 ]; then
        read -r _cc_answer
    else
        read -r _cc_answer < /dev/tty
        printf "\n"
    fi

    if [ -z "$_cc_answer" ]; then
        _cc_answer="$_cc_default"
    fi

    case "$_cc_answer" in
        [Yy]*) return 0 ;;
        *) return 1 ;;
    esac
}

# Note/message box with guide line
# Usage: clack_note "title" "line1" "line2" ...
# Or:    clack_note "title" <<EOF
#        line1
#        line2
#        EOF
# Note: Use %b to interpret escape sequences in lines
clack_note() {
    _cn_title="$1"
    shift

    printf "${GRAY}│${NC}\n"
    printf "${GRAY}│${NC}  ${GRAY}╭─${NC} ${BOLD}%s${NC}\n" "$_cn_title"

    # If arguments provided, use them as lines
    if [ $# -gt 0 ]; then
        for _cn_line in "$@"; do
            printf "${GRAY}│${NC}  ${GRAY}│${NC}  %b\n" "$_cn_line"
        done
    else
        # Read from stdin (heredoc support)
        while IFS= read -r _cn_line; do
            printf "${GRAY}│${NC}  ${GRAY}│${NC}  %b\n" "$_cn_line"
        done
    fi

    printf "${GRAY}│${NC}  ${GRAY}╰─${NC}\n"
}

# Cancel message
# Usage: clack_cancel "Message"
clack_cancel() {
    printf "${GRAY}│${NC}\n"
    printf "${GRAY}└${NC}  ${RED}%s${NC}\n" "$1"
    printf "\n"
}

# ============================================================
# Installation Status Tracking
# ============================================================
INSTALLED_COMPONENTS=""
SKIPPED_COMPONENTS=""
FAILED_COMPONENTS=""

# Track component installation status
# Usage: track_install "component_name" "status"
# Status: installed, skipped, failed
track_install() {
    _component="$1"
    _status="$2"
    case "$_status" in
        installed)
            INSTALLED_COMPONENTS="${INSTALLED_COMPONENTS}${_component}|"
            ;;
        skipped)
            SKIPPED_COMPONENTS="${SKIPPED_COMPONENTS}${_component}|"
            ;;
        failed)
            FAILED_COMPONENTS="${FAILED_COMPONENTS}${_component}|"
            ;;
    esac
}

# ============================================================
# Utility Functions
# ============================================================

# Get project root directory
# Returns: absolute path to project root, or empty if not in project
get_project_root() {
    # Start from current directory
    _dir="$PWD"

    while [ "$_dir" != "/" ]; do
        # Check for markitai project indicators
        if [ -f "$_dir/pyproject.toml" ] && [ -d "$_dir/.git" ]; then
            # Verify it's actually markitai project
            if grep -q "markitai" "$_dir/pyproject.toml" 2>/dev/null; then
                echo "$_dir"
                return 0
            fi
        fi
        _dir=$(dirname "$_dir")
    done

    return 1
}

# Check if running as root and warn
# Returns: 0 to continue, exits if user declines
warn_if_root() {
    if [ "$(id -u)" -eq 0 ]; then
        clack_warn "$(i18n warn_root)"
        clack_log "$(i18n warn_root_risk)"

        if ! clack_confirm "$(i18n confirm_continue_as_root)" "n"; then
            clack_cancel "$(i18n error_setup_failed)"
            exit 1
        fi
    fi
    return 0
}

# ============================================================
# Mode Detection
# ============================================================

# Check if running in development mode
# Returns: 0 if dev mode, 1 if user mode
is_dev_mode() {
    # Check if we're in the markitai project directory
    if [ -f "./pyproject.toml" ] && [ -d "./.git" ] && [ -d "./scripts" ]; then
        if grep -q "markitai" "./pyproject.toml" 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

# ============================================================
# Main Entry Point (placeholder for future implementation)
# ============================================================

# This file provides the foundation for the unified setup script.
# The actual installation logic will be added in subsequent tasks.
#
# Future structure:
# - main() function orchestrating the setup
# - install_prerequisites() for uv and Python
# - install_core() for markitai
# - install_optional() for Playwright, LibreOffice, FFmpeg
# - install_llm_cli() for Claude Code CLI, Copilot CLI
# - setup_dev_env() for development environment
# - print_summary() for installation summary
